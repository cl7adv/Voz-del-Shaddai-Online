<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX RADIO - Voz del Shaddai</title>
    <style>
        /* [MantÃ©n todos los estilos Matrix anteriores] */
        /* [Pega aquÃ­ todos los estilos CSS del sistema Matrix anterior] */
    </style>
</head>
<body>
    <!-- [MantÃ©n toda la estructura HTML Matrix anterior] -->

    <script>
        // ==================== CONFIGURACIÃ“N CORREGIDA ====================
        window.onload = function() {
            // SOLUCIÃ“N 1: Usar RawGit como respaldo
            const usuario = "cl7adv";
            const repo = "Voz-del-Shaddai-Online";
            const carpeta = "musica";
            
            // Variables del sistema
            let listaMusica = [];
            let indiceActual = 0;
            let estaReproduciendo = false;
            let intervaloProgreso;
            let intervaloVisualizador;
            let intervaloMatrix;
            let barrasAudio = [];
            const audio = new Audio();
            audio.volume = 0.7;
            
            // SOLUCIÃ“N 2: Lista de CDNs alternativos
            const CDNS = [
                (usuario, repo, carpeta, archivo) => 
                    `https://rawcdn.githack.com/${usuario}/${repo}/main/${carpeta}/${encodeURIComponent(archivo)}`,
                (usuario, repo, carpeta, archivo) => 
                    `https://raw.githubusercontent.com/${usuario}/${repo}/main/${carpeta}/${encodeURIComponent(archivo)}`,
                (usuario, repo, carpeta, archivo) => 
                    `https://cdn.statically.io/gh/${usuario}/${repo}/main/${carpeta}/${encodeURIComponent(archivo)}`,
                (usuario, repo, carpeta, archivo) => 
                    `https://cdn.jsdelivr.net/gh/${usuario}/${repo}@main/${carpeta}/${encodeURIComponent(archivo)}`
            ];
            
            let cdnIndex = 0;
            
            // Modos de reproducciÃ³n
            const modosReproduccion = [
                { nombre: "NORMAL", icono: "â–¶" },
                { nombre: "REPEAT ONE", icono: "ðŸ”‚" },
                { nombre: "REPEAT ALL", icono: "ðŸ”" },
                { nombre: "SHUFFLE", icono: "ðŸ”€" }
            ];
            let modoActual = 0;
            
            // ==================== ELEMENTOS DOM ====================
            const elementos = {
                status: document.getElementById('status'),
                playBtn: document.getElementById('playBtn'),
                radioBody: document.getElementById('radioBody'),
                intro: document.getElementById('intro-overlay'),
                bootStatus: document.getElementById('boot-status'),
                audioVisualizer: document.getElementById('audio-visualizer'),
                progressBar: document.getElementById('progress-bar'),
                currentTime: document.getElementById('current-time'),
                totalTime: document.getElementById('total-time'),
                trackCount: document.getElementById('track-count'),
                playlistCount: document.getElementById('playlist-count'),
                playlistContainer: document.getElementById('playlist-container'),
                trackTitle: document.getElementById('track-title'),
                trackIndex: document.getElementById('track-index'),
                trackTotal: document.getElementById('track-total'),
                trackSize: document.getElementById('track-size'),
                trackFormat: document.getElementById('track-format'),
                bufferStatus: document.getElementById('buffer-status'),
                playbackMode: document.getElementById('playback-mode'),
                notification: document.getElementById('notification'),
                systemTime: document.getElementById('system-time'),
                volumeValue: document.getElementById('volume-value')
            };
            
            // ==================== FUNCIÃ“N PARA PROBAR URLS ====================
            async function probarURL(url) {
                return new Promise((resolve) => {
                    const testAudio = new Audio();
                    testAudio.preload = "metadata";
                    testAudio.src = url;
                    
                    testAudio.addEventListener('loadedmetadata', () => {
                        resolve({ success: true, url: url });
                    });
                    
                    testAudio.addEventListener('error', () => {
                        resolve({ success: false, url: url });
                    });
                    
                    // Timeout despuÃ©s de 5 segundos
                    setTimeout(() => {
                        resolve({ success: false, url: url });
                    }, 5000);
                });
            }
            
            // ==================== OBTENER URL FUNCIONAL ====================
            async function obtenerURLCorrecta(archivo) {
                const nombreArchivo = encodeURIComponent(archivo);
                
                // Primero, intentar GitHub Pages si existe
                const ghPagesURL = `https://${usuario}.github.io/${repo}/${carpeta}/${nombreArchivo}`;
                
                // Probar GitHub Pages primero
                const test1 = await probarURL(ghPagesURL);
                if (test1.success) {
                    console.log("Usando GitHub Pages:", ghPagesURL);
                    return ghPagesURL;
                }
                
                // Probar todos los CDNs
                for (let i = 0; i < CDNS.length; i++) {
                    const url = CDNS[i](usuario, repo, carpeta, archivo);
                    console.log(`Probando CDN ${i}:`, url);
                    
                    const resultado = await probarURL(url);
                    if (resultado.success) {
                        cdnIndex = i;
                        console.log("CDN funcional encontrado:", url);
                        return url;
                    }
                }
                
                // Si nada funciona, devolver el Ãºltimo CDN como fallback
                return CDNS[CDNS.length - 1](usuario, repo, carpeta, archivo);
            }
            
            // ==================== OBTENER MÃšSICA CON VALIDACIÃ“N ====================
            async function obtenerMusica() {
                elementos.bootStatus.textContent = "> CONNECTING TO DATABASE...";
                elementos.status.textContent = "> CONNECTING TO DATABASE...";
                
                const url = `https://api.github.com/repos/${usuario}/${repo}/contents/${carpeta}`;
                
                try {
                    elementos.bootStatus.textContent = "> FETCHING AUDIO FILES...";
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const archivos = await response.json();
                    
                    // SOLUCIÃ“N 3: Filtrar solo formatos compatibles universalmente
                    listaMusica = archivos.filter(file => {
                        if (!file.name || file.type === 'dir') return false;
                        
                        const ext = file.name.toLowerCase();
                        const extension = ext.split('.').pop();
                        
                        // Formatos mÃ¡s compatibles
                        const formatosCompatibles = ['mp3', 'm4a', 'ogg', 'wav', 'mp4'];
                        
                        if (formatosCompatibles.includes(extension)) {
                            // Validar tamaÃ±o (mÃ¡ximo 50MB)
                            if (file.size && file.size > 50 * 1024 * 1024) {
                                console.warn(`Archivo muy grande omitido: ${file.name}`);
                                return false;
                            }
                            return true;
                        }
                        
                        // Intentar detectar por MIME type
                        if (file.type && file.type.startsWith('audio/')) {
                            return true;
                        }
                        
                        return false;
                    });
                    
                    if (listaMusica.length === 0) {
                        elementos.bootStatus.textContent = "> ERROR: NO COMPATIBLE AUDIO FOUND";
                        elementos.status.textContent = "ERROR: NO AUDIO FILES";
                        mostrarNotificacion("NO COMPATIBLE AUDIO FILES", "error");
                        return;
                    }
                    
                    // Ordenar alfabÃ©ticamente para consistencia
                    listaMusica.sort((a, b) => a.name.localeCompare(b.name));
                    
                    elementos.bootStatus.textContent = "> VALIDATING " + listaMusica.length + " TRACKS...";
                    
                    // SOLUCIÃ“N 4: Validar que cada archivo sea accesible
                    const tracksValidos = [];
                    for (let i = 0; i < Math.min(listaMusica.length, 10); i++) { // Validar solo primeros 10
                        const archivo = listaMusica[i];
                        try {
                            const urlTest = await obtenerURLCorrecta(archivo.name);
                            const test = await probarURL(urlTest);
                            
                            if (test.success) {
                                tracksValidos.push(archivo);
                                console.log(`âœ“ ${archivo.name} - ACCESIBLE`);
                            } else {
                                console.warn(`âœ— ${archivo.name} - INACCESIBLE`);
                            }
                        } catch (e) {
                            console.warn(`âœ— ${archivo.name} - ERROR: ${e.message}`);
                        }
                    }
                    
                    if (tracksValidos.length > 0) {
                        listaMusica = tracksValidos;
                    }
                    
                    // Mezclar aleatoriamente
                    listaMusica.sort(() => Math.random() - 0.5);
                    
                    elementos.bootStatus.textContent = "> LOADING " + listaMusica.length + " TRACKS...";
                    elementos.trackCount.textContent = listaMusica.length;
                    elementos.playlistCount.textContent = listaMusica.length;
                    elementos.trackTotal.textContent = listaMusica.length;
                    
                    // Actualizar lista de reproducciÃ³n
                    actualizarPlaylist();
                    
                    elementos.bootStatus.textContent = "> SYSTEM READY. AWAITING COMMANDS...";
                    elementos.status.textContent = "> SYSTEM READY\n" + listaMusica.length + " TRACKS LOADED";
                    
                    mostrarNotificacion(`${listaMusica.length} TRACKS LOADED SUCCESSFULLY`, 'success');
                    
                } catch (error) {
                    console.error("Database error:", error);
                    elementos.bootStatus.textContent = "> DATABASE CONNECTION FAILED";
                    elementos.status.textContent = "> CONNECTION ERROR\nCHECK NETWORK";
                    mostrarNotificacion("DATABASE CONNECTION FAILED", "error");
                }
            }
            
            // ==================== REPRODUCIR MÃšSICA CON REINTENTOS ====================
            async function reproducir() {
                if (listaMusica.length === 0) {
                    mostrarNotificacion("NO TRACKS AVAILABLE", "error");
                    return;
                }
                
                const tema = listaMusica[indiceActual];
                const nombreCorto = tema.name.length > 30 ? 
                    tema.name.substring(0, 30) + '...' : 
                    tema.name;
                
                // Actualizar informaciÃ³n
                elementos.trackTitle.textContent = nombreCorto;
                elementos.trackIndex.textContent = indiceActual + 1;
                elementos.trackFormat.textContent = tema.name.split('.').pop().toUpperCase();
                elementos.trackSize.textContent = tema.size ? 
                    `${(tema.size / 1024 / 1024).toFixed(1)} MB` : 
                    'UNKNOWN';
                
                elementos.status.textContent = `> LOADING TRACK ${indiceActual + 1}\n${nombreCorto}`;
                elementos.bufferStatus.textContent = "CONNECTING";
                elementos.playBtn.disabled = true;
                
                // Limpiar intervalo anterior
                if (intervaloProgreso) clearInterval(intervaloProgreso);
                
                // SOLUCIÃ“N 5: Sistema de reintentos con CDNs alternativos
                let urlFuncional = null;
                let intentos = 0;
                const maxIntentos = CDNS.length + 1; // +1 para GitHub Pages
                
                while (!urlFuncional && intentos < maxIntentos) {
                    try {
                        // Obtener URL del CDN actual
                        const cdnFunc = CDNS[cdnIndex % CDNS.length];
                        const url = cdnFunc(usuario, repo, carpeta, tema.name);
                        
                        console.log(`Intento ${intentos + 1}: Probando ${url}`);
                        
                        // Probar la URL
                        const test = await probarURL(url);
                        
                        if (test.success) {
                            urlFuncional = url;
                            console.log("URL funcional encontrada:", url);
                            break;
                        }
                        
                        // Rotar al siguiente CDN
                        cdnIndex = (cdnIndex + 1) % CDNS.length;
                        intentos++;
                        
                    } catch (error) {
                        console.warn(`Intento ${intentos + 1} fallÃ³:`, error);
                        cdnIndex = (cdnIndex + 1) % CDNS.length;
                        intentos++;
                    }
                }
                
                if (!urlFuncional) {
                    // Ãšltimo intento con GitHub Pages
                    const ghPagesURL = `https://${usuario}.github.io/${repo}/${carpeta}/${encodeURIComponent(tema.name)}`;
                    const test = await probarURL(ghPagesURL);
                    
                    if (test.success) {
                        urlFuncional = ghPagesURL;
                    } else {
                        // Si nada funciona, usar GitHub raw
                        urlFuncional = `https://raw.githubusercontent.com/${usuario}/${repo}/main/${carpeta}/${encodeURIComponent(tema.name)}`;
                    }
                }
                
                // Configurar audio
                audio.src = urlFuncional;
                audio.load();
                
                // Configurar eventos de audio
                audio.onerror = function(e) {
                    console.error("Audio error:", e);
                    elementos.status.textContent = "> FORMAT ERROR\nTRYING NEXT TRACK...";
                    elementos.status.className = 'error';
                    elementos.bufferStatus.textContent = "ERROR";
                    
                    // Intentar siguiente canciÃ³n
                    setTimeout(() => {
                        siguienteTema();
                    }, 2000);
                };
                
                // Intentar reproducir
                try {
                    await audio.play();
                    
                    elementos.status.textContent = `> NOW PLAYING\n${nombreCorto}`;
                    elementos.status.className = 'playing';
                    elementos.playBtn.textContent = "â¸";
                    elementos.playBtn.disabled = false;
                    estaReproduciendo = true;
                    elementos.bufferStatus.textContent = "PLAYING";
                    
                    // Iniciar barra de progreso
                    intervaloProgreso = setInterval(actualizarProgreso, 100);
                    
                    // Actualizar playlist
                    actualizarPlaylist();
                    
                    mostrarNotificacion(`PLAYING: ${nombreCorto}`);
                    
                } catch (error) {
                    console.error("Playback error:", error);
                    
                    // SOLUCIÃ“N 6: Manejo especÃ­fico de errores comunes
                    if (error.name === 'NotSupportedError') {
                        elementos.status.textContent = "> FORMAT NOT SUPPORTED\nSKIPPING...";
                        mostrarNotificacion("UNSUPPORTED AUDIO FORMAT", "error");
                    } else if (error.name === 'NotAllowedError') {
                        elementos.status.textContent = "> AUTOPLAY BLOCKED\nCLICK PLAY BUTTON";
                        mostrarNotificacion("CLICK PLAY BUTTON TO START", "warning");
                        elementos.playBtn.disabled = false;
                        elementos.playBtn.textContent = "â–¶";
                        return;
                    } else {
                        elementos.status.textContent = "> PLAYBACK ERROR\nSKIPPING...";
                    }
                    
                    elementos.status.className = 'error';
                    elementos.playBtn.textContent = "â–¶";
                    elementos.playBtn.disabled = false;
                    estaReproduciendo = false;
                    elementos.bufferStatus.textContent = "ERROR";
                    
                    // Intentar siguiente canciÃ³n automÃ¡ticamente
                    setTimeout(() => {
                        siguienteTema();
                    }, 2000);
                }
            }
            
            // ==================== FUNCIONES RESTANTES (sin cambios) ====================
            // [MantÃ©n todas las otras funciones del sistema Matrix anterior]
            // como iniciarMatrixRain, crearVisualizador, mostrarNotificacion, etc.
            
            // SOLUCIÃ“N 7: FunciÃ³n para verificar repositorio
            async function verificarRepositorio() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${usuario}/${repo}`);
                    if (!response.ok) throw new Error("Repositorio no encontrado");
                    
                    const data = await response.json();
                    console.log("Repositorio encontrado:", data.full_name);
                    return true;
                } catch (error) {
                    console.error("Error verificando repositorio:", error);
                    elementos.bootStatus.textContent = "> REPOSITORY NOT FOUND";
                    return false;
                }
            }
            
            // ==================== INICIALIZAR SISTEMA ====================
            async function inicializarSistema() {
                // Verificar repositorio primero
                const repoExiste = await verificarRepositorio();
                
                if (!repoExiste) {
                    elementos.bootStatus.textContent = "> ERROR: REPOSITORY NOT FOUND";
                    elementos.status.textContent = "> CHECK REPO SETTINGS";
                    mostrarNotificacion("REPOSITORY NOT FOUND", "error");
                    return;
                }
                
                // Iniciar efectos visuales
                if (typeof iniciarMatrixRain === 'function') {
                    iniciarMatrixRain();
                }
                
                // Iniciar visualizador
                if (typeof crearVisualizador === 'function') {
                    crearVisualizador();
                }
                
                // Obtener mÃºsica
                await obtenerMusica();
                
                // Configurar evento del botÃ³n de inicio
                document.getElementById('startBtn').onclick = function() {
                    elementos.intro.style.opacity = '0';
                    setTimeout(() => {
                        elementos.intro.style.visibility = 'hidden';
                        elementos.radioBody.classList.add('radio-visible');
                        
                        // SOLUCIÃ“N 8: Reproducir solo si hay mÃºsica vÃ¡lida
                        if (listaMusica.length > 0) {
                            // PequeÃ±o delay para asegurar que la UI estÃ© lista
                            setTimeout(() => {
                                reproducir();
                            }, 500);
                        } else {
                            mostrarNotificacion("NO VALID AUDIO FOUND", "error");
                        }
                    }, 800);
                };
            }
            
            // Iniciar todo
            inicializarSistema();
        };
    </script>
</body>
</html>
