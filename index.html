<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Voz del Shaddai Radio - Emisora Cristiana 24/7</title>
    
    <!-- Meta Tags para Compartir -->
    <meta name="description" content=" Escucha Voz del Shaddai Radio - Emisora Cristiana en vivo 24/7. M煤sica inspiradora sin interrupciones.">
    <meta name="keywords" content="radio cristiana, emisora online, m煤sica cristiana, radio en vivo, 24/7">
    <meta property="og:title" content=" Voz del Shaddai Radio - Emisora Cristiana 24/7">
    <meta property="og:description" content="Sintoniza nuestra emisora cristiana en vivo. M煤sica inspiradora las 24 horas.">
    
    <!-- Estilos y Fuentes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --primary-light: #4285f4;
            --secondary: #ea4335;
            --accent: #fbbc05;
            --success: #34a853;
            --dark: #202124;
            --darker: #171717;
            --light: #ffffff;
            --gray: #9aa0a6;
            --gray-dark: #5f6368;
            
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
            --radius: 16px;
            --radius-sm: 8px;
            
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== LOADING SCREEN ===== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-light);
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 1rem;
        }

        .loading-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        /* ===== MAIN APP ===== */
        #app {
            display: none;
            min-height: 100vh;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .app-loaded {
            display: block;
        }

        /* ===== RADIO HEADER ===== */
        .radio-header {
            background: rgba(32, 33, 36, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
        }

        .radio-brand {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .radio-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: var(--shadow-lg);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .radio-info h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .radio-info p {
            color: var(--gray);
            font-size: 1rem;
        }

        .radio-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--success);
        }

        /* ===== LIVE BROADCAST SECTION ===== */
        .broadcast-section {
            background: rgba(32, 33, 36, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        .broadcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--secondary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .broadcast-time {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* ===== NOW PLAYING ===== */
        .now-playing-card {
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.2), rgba(234, 67, 53, 0.2));
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .now-playing-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .track-display {
            display: flex;
            align-items: center;
            gap: 2rem;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .track-display {
                flex-direction: column;
                text-align: center;
            }
        }

        .album-art {
            width: 140px;
            height: 140px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1.2;
            color: var(--light);
        }

        .track-artist {
            color: var(--primary-light);
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .track-meta {
            display: flex;
            gap: 2rem;
            color: var(--gray);
            font-size: 1rem;
        }

        /* ===== LISTENER CONTROLS (SOLO VOLUMEN Y ON/OFF) ===== */
        .listener-controls {
            background: rgba(32, 33, 36, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        .controls-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: var(--light);
            text-align: center;
        }

        .control-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            flex-wrap: wrap;
        }

        .power-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .power-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
        }

        .power-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(52, 168, 83, 0.4);
        }

        .power-btn.off {
            background: linear-gradient(135deg, var(--secondary), #c62828);
        }

        .volume-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
        }

        .volume-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .volume-icon {
            font-size: 1.8rem;
            color: var(--primary-light);
            width: 40px;
        }

        .volume-slider {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid var(--light);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .volume-value {
            width: 60px;
            text-align: center;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-light);
        }

        /* ===== ESPECTRO MUSICAL FUNCIONAL ===== */
        .spectrum-section {
            background: rgba(32, 33, 36, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        .spectrum-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spectrum-container {
            width: 100%;
            height: 180px;
            position: relative;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        #spectrum-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ===== SISTEMA INFO ===== */
        .system-info {
            background: rgba(32, 33, 36, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--primary);
        }

        .info-title {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--light);
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--dark);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                gap: 2rem;
            }
            
            .volume-control {
                min-width: 100%;
            }
            
            .track-title {
                font-size: 1.8rem;
            }
            
            .notification {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h1 class="loading-title">VOZ DEL SHADDAI</h1>
            <p class="loading-subtitle">Sintonizando emisora cristiana...</p>
            <div id="loading-details" style="color: var(--gray); margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Radio Header -->
        <header class="radio-header">
            <div class="header-content">
                <div class="radio-brand">
                    <div class="radio-logo">
                        <i class="fas fa-cross"></i>
                    </div>
                    <div class="radio-info">
                        <h1>VOZ DEL SHADDAI RADIO</h1>
                        <p>Emisora Cristiana en Vivo 24/7</p>
                    </div>
                </div>
                <div class="radio-stats">
                    <div class="stat-item">
                        <div class="stat-label">OYENTES</div>
                        <div class="stat-value" id="listener-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ESTADO</div>
                        <div class="stat-value" id="broadcast-status" style="color: var(--success);">EN VIVO</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Broadcast Section -->
        <section class="broadcast-section">
            <div class="broadcast-header">
                <div class="live-indicator">
                    <div class="live-dot" style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                    TRANSMITIENDO EN VIVO
                </div>
                <div class="broadcast-time" id="broadcast-time">Cargando...</div>
            </div>

            <!-- Now Playing -->
            <div class="now-playing-card">
                <div class="track-display">
                    <div class="album-art">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="track-info">
                        <h2 class="track-title" id="track-title">Sintonizando emisora...</h2>
                        <p class="track-artist" id="track-artist">Voz del Shaddai Radio</p>
                        <div class="track-meta">
                            <span id="current-time">00:00</span>
                            <span id="track-duration">00:00</span>
                            <span id="bitrate">128 kbps</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Listener Controls (Solo volumen y power) -->
        <section class="listener-controls">
            <h3 class="controls-title">CONTROLES DEL OYENTE</h3>
            <div class="control-group">
                <div class="power-control">
                    <button class="power-btn" id="power-btn" title="Encender/Apagar radio">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <span style="color: var(--gray); font-size: 0.9rem;">ON/OFF</span>
                </div>
                
                <div class="volume-control">
                    <div class="volume-display">
                        <div class="volume-icon">
                            <i class="fas fa-volume-up" id="volume-icon"></i>
                        </div>
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
                        <div class="volume-value" id="volume-value">70%</div>
                    </div>
                    <span style="color: var(--gray); font-size: 0.9rem;">VOLUMEN</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem; color: var(--gray); font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Los controles de reproducci贸n son autom谩ticos del sistema
            </div>
        </section>

        <!-- Espectro Musical -->
        <section class="spectrum-section">
            <div class="spectrum-title">
                <i class="fas fa-wave-square"></i> Espectro Musical en Vivo
            </div>
            <div class="spectrum-container">
                <canvas id="spectrum-canvas"></canvas>
            </div>
        </section>

        <!-- System Info -->
        <section class="system-info">
            <h3 style="margin-bottom: 1rem; color: var(--light);">Informaci贸n del Sistema</h3>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-title">MODO DE TRANSMISIN</div>
                    <div class="info-value">RADIO EMISORA</div>
                </div>
                <div class="info-card">
                    <div class="info-title">REPRODUCCIN</div>
                    <div class="info-value" id="playback-mode">ALEATORIA AUTOMTICA</div>
                </div>
                <div class="info-card">
                    <div class="info-title">TOTAL DE CANCIONES</div>
                    <div class="info-value" id="total-songs">0</div>
                </div>
                <div class="info-card">
                    <div class="info-title">TIEMPO TRANSCURRIDO</div>
                    <div class="info-value" id="uptime">00:00:00</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <div>
            <strong id="notification-title">Notificaci贸n</strong>
            <p id="notification-message">Mensaje de notificaci贸n</p>
        </div>
    </div>

    <script>
        // ============== SISTEMA DE RADIO EMISORA ==============
        class RadioStationSystem {
            constructor() {
                // Configuraci贸n del sistema
                this.config = {
                    githubUser: 'cl7adv',
                    repo: 'Voz-del-Shaddai-Online',
                    musicFolder: 'musica',
                    
                    // Fuentes de audio
                    sources: [
                        (user, repo, folder, file) => 
                            `https://cdn.jsdelivr.net/gh/${user}/${repo}@main/${folder}/${encodeURIComponent(file)}`,
                        (user, repo, folder, file) => 
                            `https://rawcdn.githack.com/${user}/${repo}/main/${folder}/${encodeURIComponent(file)}`,
                        (user, repo, folder, file) => 
                            `https://raw.githubusercontent.com/${user}/${repo}/main/${folder}/${encodeURIComponent(file)}`
                    ],
                    
                    supportedFormats: ['mp3', 'm4a', 'wav', 'ogg'],
                    defaultVolume: 0.7,
                    shuffleMode: true, // Siempre aleatorio
                    autoRepeat: true,  // Siempre repetir toda la lista
                    crossfadeDuration: 2000, // 2 segundos de fade entre canciones
                    
                    // Sistema de oyentes (simulado)
                    listenerUpdateInterval: 30000, // Actualizar cada 30 segundos
                    minListeners: 5,
                    maxListeners: 150
                };

                // Estado del sistema
                this.state = {
                    tracks: [],
                    currentTrackIndex: 0,
                    isPlaying: false,
                    isPoweredOn: true, // Radio encendida por defecto
                    volume: this.config.defaultVolume,
                    currentSource: 0,
                    shuffleQueue: [],
                    audioContext: null,
                    analyser: null,
                    dataArray: null,
                    animationFrame: null,
                    startTime: Date.now(),
                    listeners: 0,
                    currentTime: 0,
                    nextTrackTimer: null
                };

                // Elementos DOM
                this.elements = {};
                this.audio = new Audio();
                this.audio.crossOrigin = "anonymous";
                this.audio.volume = this.state.volume;
                
                // Canvas para espectro
                this.canvas = null;
                this.ctx = null;
                
                // Inicializar el sistema
                this.init();
            }

            // ============== INICIALIZACIN ==============
            async init() {
                this.cacheElements();
                this.setupEventListeners();
                this.setupAudioEvents();
                this.initSpectrum();
                await this.loadTracks();
                this.startSystem();
                this.hideLoadingScreen();
                
                // Iniciar simulador de oyentes
                this.startListenerSimulator();
                
                // Iniciar actualizaci贸n de tiempo
                this.updateBroadcastTime();
                setInterval(() => this.updateBroadcastTime(), 60000);
                
                // Iniciar contador de uptime
                setInterval(() => this.updateUptime(), 1000);
            }

            cacheElements() {
                this.elements = {
                    loadingScreen: document.getElementById('loading-screen'),
                    loadingDetails: document.getElementById('loading-details'),
                    app: document.getElementById('app'),
                    
                    // Informaci贸n de transmisi贸n
                    trackTitle: document.getElementById('track-title'),
                    trackArtist: document.getElementById('track-artist'),
                    currentTime: document.getElementById('current-time'),
                    broadcastTime: document.getElementById('broadcast-time'),
                    
                    // Estad铆sticas
                    listenerCount: document.getElementById('listener-count'),
                    broadcastStatus: document.getElementById('broadcast-status'),
                    totalSongs: document.getElementById('total-songs'),
                    playbackMode: document.getElementById('playback-mode'),
                    uptime: document.getElementById('uptime'),
                    
                    // Controles del oyente
                    powerBtn: document.getElementById('power-btn'),
                    volumeSlider: document.getElementById('volume-slider'),
                    volumeValue: document.getElementById('volume-value'),
                    volumeIcon: document.getElementById('volume-icon'),
                    
                    // Espectro
                    spectrumCanvas: document.getElementById('spectrum-canvas'),
                    
                    // Notificaci贸n
                    notification: document.getElementById('notification'),
                    notificationTitle: document.getElementById('notification-title'),
                    notificationMessage: document.getElementById('notification-message')
                };
            }

            setupEventListeners() {
                // Controles del oyente (solo power y volumen)
                this.elements.powerBtn.addEventListener('click', () => this.togglePower());
                this.elements.volumeSlider.addEventListener('input', (e) => {
                    this.setVolume(e.target.value / 100);
                });
            }

            setupAudioEvents() {
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => this.onTrackLoaded());
                this.audio.addEventListener('ended', () => this.onTrackEnded());
                this.audio.addEventListener('error', (e) => this.onAudioError(e));
                this.audio.addEventListener('play', () => this.onPlay());
                this.audio.addEventListener('pause', () => this.onPause());
            }

            // ============== ESPECTRO MUSICAL FUNCIONAL ==============
            initSpectrum() {
                this.canvas = this.elements.spectrumCanvas;
                this.ctx = this.canvas.getContext('2d');
                
                // Configurar tama帽o inicial
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }

            initAudioAnalyser() {
                try {
                    // Crear AudioContext
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.state.analyser = this.state.audioContext.createAnalyser();
                    
                    // Conectar el audio al analizador
                    const source = this.state.audioContext.createMediaElementSource(this.audio);
                    source.connect(this.state.analyser);
                    this.state.analyser.connect(this.state.audioContext.destination);
                    
                    // Configurar analizador
                    this.state.analyser.fftSize = 256;
                    const bufferLength = this.state.analyser.frequencyBinCount;
                    this.state.dataArray = new Uint8Array(bufferLength);
                    
                } catch (error) {
                    console.warn('AudioContext no disponible:', error);
                }
            }

            startSpectrum() {
                if (!this.state.isPlaying || !this.state.isPoweredOn) return;
                
                // Inicializar analizador si no existe
                if (!this.state.audioContext || this.state.audioContext.state === 'suspended') {
                    this.initAudioAnalyser();
                }
                
                if (this.state.animationFrame) {
                    cancelAnimationFrame(this.state.animationFrame);
                }
                
                const draw = () => {
                    if (!this.state.isPlaying || !this.state.isPoweredOn) {
                        if (this.state.animationFrame) {
                            cancelAnimationFrame(this.state.animationFrame);
                            this.state.animationFrame = null;
                        }
                        return;
                    }
                    
                    this.state.animationFrame = requestAnimationFrame(draw);
                    
                    if (!this.state.analyser || !this.state.dataArray) return;
                    
                    // Obtener datos de frecuencia
                    this.state.analyser.getByteFrequencyData(this.state.dataArray);
                    
                    // Limpiar canvas
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Dibujar espectro mejorado
                    this.drawEnhancedSpectrum();
                };
                
                draw();
            }

            drawEnhancedSpectrum() {
                const width = this.canvas.width;
                const height = this.canvas.height;
                const barCount = 64; // Menos barras para mejor rendimiento
                const barWidth = width / barCount;
                
                // Fondo con gradiente
                const gradient = this.ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, 'rgba(26, 115, 232, 0.1)');
                gradient.addColorStop(1, 'rgba(234, 67, 53, 0.1)');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, width, height);
                
                // Dibujar barras
                for(let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor(i * this.state.dataArray.length / barCount);
                    const barHeight = (this.state.dataArray[dataIndex] / 255) * height * 0.8;
                    
                    // Color basado en la altura de la barra
                    const intensity = barHeight / (height * 0.8);
                    const hue = 200 + (intensity * 160); // Azul a rojo
                    
                    // Gradiente para cada barra
                    const barGradient = this.ctx.createLinearGradient(0, height - barHeight, 0, height);
                    barGradient.addColorStop(0, `hsla(${hue}, 100%, 60%, 0.9)`);
                    barGradient.addColorStop(1, `hsla(${hue}, 100%, 30%, 0.3)`);
                    
                    // Dibujar barra
                    this.ctx.fillStyle = barGradient;
                    this.ctx.fillRect(i * barWidth, height - barHeight, barWidth - 2, barHeight);
                    
                    // Efecto de brillo
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + intensity * 0.3})`;
                    this.ctx.fillRect(i * barWidth, height - barHeight, barWidth - 2, 2);
                    
                    // Sombra
                    this.ctx.shadowColor = `hsla(${hue}, 100%, 50%, 0.5)`;
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowOffsetX = 0;
                    this.ctx.shadowOffsetY = 0;
                    
                    // Restaurar sombra
                    this.ctx.shadowBlur = 0;
                }
                
                // L铆nea superior suave
                this.ctx.beginPath();
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx.lineJoin = 'round';
                
                for(let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor(i * this.state.dataArray.length / barCount);
                    const barHeight = (this.state.dataArray[dataIndex] / 255) * height * 0.8;
                    const x = i * barWidth + (barWidth / 2);
                    const y = height - barHeight;
                    
                    if(i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.stroke();
            }

            // ============== CARGA Y GESTIN DE MSICA ==============
            async loadTracks() {
                try {
                    this.updateLoadingStatus('Conectando con el servidor de m煤sica...');
                    
                    const apiUrl = `https://api.github.com/repos/${this.config.githubUser}/${this.config.repo}/contents/${this.config.musicFolder}`;
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                    
                    this.updateLoadingStatus('Cargando lista de reproducci贸n...');
                    
                    const files = await response.json();
                    
                    // Filtrar archivos de audio
                    this.state.tracks = files
                        .filter(file => {
                            if (file.type !== 'file') return false;
                            const ext = file.name.toLowerCase().split('.').pop();
                            return this.config.supportedFormats.includes(ext);
                        })
                        .map((file, index) => ({
                            id: index + 1,
                            name: file.name,
                            url: this.getTrackUrl(file.name),
                            duration: 0,
                            lastPlayed: 0
                        }));
                    
                    if (this.state.tracks.length === 0) {
                        throw new Error('No se encontraron archivos de m煤sica');
                    }
                    
                    this.updateLoadingStatus(`${this.state.tracks.length} canciones cargadas`);
                    
                    // Actualizar UI
                    this.elements.totalSongs.textContent = this.state.tracks.length;
                    this.elements.broadcastStatus.textContent = 'EN VIVO';
                    this.elements.broadcastStatus.style.color = 'var(--success)';
                    
                    // Crear cola aleatoria inicial
                    this.generateShuffleQueue();
                    
                    this.showNotification('Emisora lista', `${this.state.tracks.length} canciones en lista`, 'success');
                    
                } catch (error) {
                    console.error('Error cargando m煤sica:', error);
                    this.showNotification('Error de conexi贸n', 'Verificando fuentes alternativas...', 'error');
                    
                    // Intentar cargar algunas canciones de ejemplo
                    this.loadFallbackTracks();
                }
            }

            loadFallbackTracks() {
                // Canciones de ejemplo como fallback
                this.state.tracks = [
                    { id: 1, name: 'Alabanza Cristiana - Canci贸n 1', url: '', duration: 180 },
                    { id: 2, name: 'Alabanza Cristiana - Canci贸n 2', url: '', duration: 210 },
                    { id: 3, name: 'Alabanza Cristiana - Canci贸n 3', url: '', duration: 195 }
                ];
                
                this.elements.totalSongs.textContent = this.state.tracks.length;
                this.generateShuffleQueue();
                this.showNotification('Modo demostraci贸n', 'Usando lista de ejemplo', 'warning');
            }

            getTrackUrl(filename) {
                const sourceFunc = this.config.sources[this.state.currentSource];
                return sourceFunc(this.config.githubUser, this.config.repo, this.config.musicFolder, filename);
            }

            generateShuffleQueue() {
                // Crear una cola aleatoria de reproducci贸n
                this.state.shuffleQueue = [...this.state.tracks]
                    .sort(() => Math.random() - 0.5)
                    .map(track => track.id);
                
                console.log('Cola aleatoria generada:', this.state.shuffleQueue);
            }

            getNextTrackIndex() {
                if (this.config.shuffleMode) {
                    // Modo aleatorio: obtener siguiente de la cola
                    if (this.state.shuffleQueue.length === 0) {
                        this.generateShuffleQueue(); // Regenerar si est谩 vac铆a
                    }
                    
                    const nextId = this.state.shuffleQueue.shift();
                    return this.state.tracks.findIndex(track => track.id === nextId);
                } else {
                    // Modo secuencial
                    return (this.state.currentTrackIndex + 1) % this.state.tracks.length;
                }
            }

            // ============== SISTEMA DE TRANSMISIN ==============
            startSystem() {
                // Iniciar reproducci贸n autom谩tica
                this.playNextTrack();
                
                // Configurar temporizador para siguiente canci贸n
                this.setupNextTrackTimer();
            }

            async playNextTrack() {
                if (this.state.tracks.length === 0) {
                    console.log('No hay canciones disponibles');
                    return;
                }
                
                // Obtener siguiente canci贸n
                this.state.currentTrackIndex = this.getNextTrackIndex();
                const track = this.state.tracks[this.state.currentTrackIndex];
                
                try {
                    // Actualizar UI
                    this.elements.trackTitle.textContent = this.formatTrackName(track.name);
                    this.elements.trackArtist.textContent = 'Voz del Shaddai Radio';
                    
                    // Detener audio actual si est谩 reproduciendo
                    if (this.state.isPlaying) {
                        this.audio.pause();
                        this.state.isPlaying = false;
                    }
                    
                    // Cargar y reproducir nueva canci贸n
                    const url = this.getTrackUrl(track.name);
                    this.audio.src = url;
                    this.audio.load();
                    
                    // Esperar a que cargue
                    await new Promise((resolve, reject) => {
                        const onCanPlay = () => {
                            this.audio.removeEventListener('canplay', onCanPlay);
                            resolve();
                        };
                        
                        const onError = () => {
                            this.audio.removeEventListener('error', onError);
                            reject(new Error('Error cargando audio'));
                        };
                        
                        this.audio.addEventListener('canplay', onCanPlay);
                        this.audio.addEventListener('error', onError);
                        
                        setTimeout(() => reject(new Error('Timeout')), 10000);
                    });
                    
                    // Iniciar reproducci贸n
                    if (this.state.isPoweredOn) {
                        await this.play();
                    }
                    
                    // Registrar tiempo de reproducci贸n
                    track.lastPlayed = Date.now();
                    
                    // Programar siguiente canci贸n
                    this.setupNextTrackTimer();
                    
                } catch (error) {
                    console.error('Error reproduciendo:', error);
                    
                    // Intentar siguiente canci贸n despu茅s de un retraso
                    setTimeout(() => {
                        this.showNotification('Error', 'Saltando a siguiente canci贸n', 'error');
                        this.playNextTrack();
                    }, 3000);
                }
            }

            async play() {
                if (!this.state.isPoweredOn) return;
                
                try {
                    // Reanudar AudioContext si est谩 suspendido
                    if (this.state.audioContext && this.state.audioContext.state === 'suspended') {
                        await this.state.audioContext.resume();
                    }
                    
                    await this.audio.play();
                    this.state.isPlaying = true;
                    
                    // Iniciar espectro
                    this.startSpectrum();
                    
                    // Actualizar UI
                    this.elements.powerBtn.classList.remove('off');
                    
                    console.log('Reproduciendo:', this.state.tracks[this.state.currentTrackIndex].name);
                    
                } catch (error) {
                    console.error('Error al reproducir:', error);
                    this.state.isPlaying = false;
                }
            }

            setupNextTrackTimer() {
                // Limpiar temporizador anterior
                if (this.state.nextTrackTimer) {
                    clearTimeout(this.state.nextTrackTimer);
                }
                
                // Calcular tiempo para siguiente canci贸n (90% de la duraci贸n para fade)
                const currentDuration = this.audio.duration || 180; // 3 minutos por defecto
                const nextTrackTime = (currentDuration * 0.9) * 1000; // 90% de la duraci贸n en ms
                
                // Programar siguiente canci贸n
                this.state.nextTrackTimer = setTimeout(() => {
                    this.playNextTrack();
                }, nextTrackTime);
                
                console.log('Siguiente canci贸n en:', Math.round(nextTrackTime / 1000), 'segundos');
            }

            // ============== CONTROLES DEL OYENTE ==============
            togglePower() {
                this.state.isPoweredOn = !this.state.isPoweredOn;
                
                if (this.state.isPoweredOn) {
                    // Encender radio
                    this.elements.powerBtn.classList.remove('off');
                    this.play();
                    this.showNotification('Radio encendida', 'Sintonizando emisora...', 'success');
                } else {
                    // Apagar radio
                    this.elements.powerBtn.classList.add('off');
                    this.audio.pause();
                    this.state.isPlaying = false;
                    
                    // Detener espectro
                    if (this.state.animationFrame) {
                        cancelAnimationFrame(this.state.animationFrame);
                        this.state.animationFrame = null;
                    }
                    
                    this.showNotification('Radio apagada', '', 'info');
                }
            }

            setVolume(value) {
                this.state.volume = value;
                this.audio.volume = value;
                this.elements.volumeSlider.value = value * 100;
                this.elements.volumeValue.textContent = `${Math.round(value * 100)}%`;
                
                // Actualizar icono
                if (value === 0) {
                    this.elements.volumeIcon.className = 'fas fa-volume-mute';
                } else if (value < 0.3) {
                    this.elements.volumeIcon.className = 'fas fa-volume-down';
                } else if (value < 0.7) {
                    this.elements.volumeIcon.className = 'fas fa-volume-up';
                } else {
                    this.elements.volumeIcon.className = 'fas fa-volume-up';
                }
            }

            // ============== SISTEMA DE OYENTES ==============
            startListenerSimulator() {
                // Inicializar con algunos oyentes
                this.state.listeners = Math.floor(
                    Math.random() * (this.config.maxListeners - this.config.minListeners) + this.config.minListeners
                );
                this.updateListenerCount();
                
                // Simular cambios en oyentes
                setInterval(() => {
                    this.simulateListenerChange();
                }, this.config.listenerUpdateInterval);
            }

            simulateListenerChange() {
                // Cambio aleatorio de 卤10 oyentes
                const change = Math.floor(Math.random() * 20) - 10;
                this.state.listeners = Math.max(
                    this.config.minListeners,
                    Math.min(this.config.maxListeners, this.state.listeners + change)
                );
                
                this.updateListenerCount();
            }

            updateListenerCount() {
                this.elements.listenerCount.textContent = this.state.listeners;
            }

            // ============== ACTUALIZACIN DE UI ==============
            updateProgress() {
                if (!this.audio.duration || isNaN(this.audio.duration)) return;
                
                this.state.currentTime = this.audio.currentTime;
                const duration = this.audio.duration;
                
                // Actualizar tiempos
                this.elements.currentTime.textContent = this.formatTime(this.state.currentTime);
                
                // Actualizar duraci贸n si est谩 disponible
                if (duration && !isNaN(duration)) {
                    const track = this.state.tracks[this.state.currentTrackIndex];
                    if (!track.duration || track.duration !== duration) {
                        track.duration = duration;
                    }
                }
            }

            updateBroadcastTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                this.elements.broadcastTime.textContent = `Hora: ${timeString}`;
            }

            updateUptime() {
                const uptime = Date.now() - this.state.startTime;
                const hours = Math.floor(uptime / 3600000);
                const minutes = Math.floor((uptime % 3600000) / 60000);
                const seconds = Math.floor((uptime % 60000) / 1000);
                
                this.elements.uptime.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateLoadingStatus(message) {
                if (this.elements.loadingDetails) {
                    this.elements.loadingDetails.textContent = message;
                }
            }

            formatTrackName(name) {
                const withoutExt = name.replace(/\.[^/.]+$/, '');
                return withoutExt.length > 40 ? withoutExt.substring(0, 40) + '...' : withoutExt;
            }

            formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '00:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // ============== EVENT HANDLERS ==============
            onTrackLoaded() {
                const track = this.state.tracks[this.state.currentTrackIndex];
                if (this.audio.duration && !isNaN(this.audio.duration)) {
                    track.duration = this.audio.duration;
                }
                
                // Actualizar tiempo total si est谩 disponible
                if (track.duration) {
                    const durationElement = document.getElementById('track-duration');
                    if (durationElement) {
                        durationElement.textContent = this.formatTime(track.duration);
                    }
                }
            }

            onTrackEnded() {
                // Reproducir siguiente canci贸n autom谩ticamente
                console.log('Canci贸n finalizada, reproduciendo siguiente...');
                this.playNextTrack();
            }

            onAudioError(error) {
                console.error('Error de audio:', error);
                
                // Cambiar a siguiente fuente si es posible
                this.state.currentSource = (this.state.currentSource + 1) % this.config.sources.length;
                
                // Intentar siguiente canci贸n
                setTimeout(() => {
                    this.showNotification('Error de audio', 'Saltando a siguiente canci贸n', 'error');
                    this.playNextTrack();
                }, 3000);
            }

            onPlay() {
                this.state.isPlaying = true;
            }

            onPause() {
                this.state.isPlaying = false;
            }

            // ============== NOTIFICACIONES ==============
            showNotification(title, message, type = 'info') {
                this.elements.notificationTitle.textContent = title;
                this.elements.notificationMessage.textContent = message;
                
                // Establecer color seg煤n tipo
                let color = 'var(--primary)';
                if (type === 'success') color = 'var(--success)';
                if (type === 'error') color = 'var(--secondary)';
                
                this.elements.notification.style.borderLeftColor = color;
                
                // Mostrar
                this.elements.notification.classList.add('show');
                
                // Ocultar despu茅s de 3 segundos
                setTimeout(() => {
                    this.elements.notification.classList.remove('show');
                }, 3000);
            }

            // ============== UTILIDADES ==============
            hideLoadingScreen() {
                setTimeout(() => {
                    this.elements.loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        this.elements.loadingScreen.style.display = 'none';
                        this.elements.app.style.display = 'block';
                        setTimeout(() => {
                            this.elements.app.classList.add('app-loaded');
                        }, 50);
                    }, 500);
                }, 1500);
            }
        }

        // ============== INICIAR SISTEMA ==============
        document.addEventListener('DOMContentLoaded', () => {
            window.radioStation = new RadioStationSystem();
            
            // Mostrar instrucciones
            setTimeout(() => {
                window.radioStation.showNotification(
                    'Bienvenido a Voz del Shaddai Radio',
                    'Emisora cristiana en vivo 24/7',
                    'success'
                );
            }, 2000);
        });
    </script>
</body>
</html>
