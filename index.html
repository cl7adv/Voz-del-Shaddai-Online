<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游꿧 VOZ DEL SHADDAI - Radio Cristiana 24/7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET Y VARIABLES ===== */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --primary-light: #4cc9f0;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4ade80;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --darker: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-dark: #334155;
            
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* ===== LOADING SCREEN ===== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-light);
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
        }

        .loading-subtitle {
            color: var(--gray);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* ===== MAIN APP ===== */
        #app {
            display: none;
            min-height: 100vh;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-loaded {
            display: block;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: var(--shadow);
        }

        .logo-text h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-text p {
            color: var(--gray);
            font-size: 1rem;
        }

        /* ===== VISUALIZER ===== */
        .visualizer-section {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .visualizer-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .visualizer-container {
            width: 100%;
            height: 200px;
            position: relative;
        }

        #visualizer-canvas {
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            background: rgba(0, 0, 0, 0.3);
        }

        /* ===== NOW PLAYING ===== */
        .now-playing {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .track-display {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .album-art {
            width: 140px;
            height: 140px;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .track-artist {
            color: var(--primary-light);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .track-meta {
            display: flex;
            gap: 2rem;
            color: var(--gray);
            font-size: 1rem;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* ===== BOTONES GRANDES ===== */
        .controls-container {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: var(--radius);
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .control-btn.primary {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            font-size: 2.5rem;
        }

        .secondary-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .secondary-btn {
            padding: 1rem 2rem;
            border-radius: var(--radius);
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .secondary-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ===== VOLUME ===== */
        .volume-section {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .volume-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid var(--light);
        }

        /* ===== PLAYLIST ===== */
        .playlist-section {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .playlist-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-light);
        }

        .playlist {
            max-height: 400px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 0.5rem;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-item.active {
            background: rgba(67, 97, 238, 0.3);
            border-left: 4px solid var(--primary);
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--dark);
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .track-display {
                flex-direction: column;
                text-align: center;
            }
            
            .album-art {
                width: 180px;
                height: 180px;
            }
            
            .main-controls {
                gap: 1rem;
            }
            
            .control-btn {
                width: 70px;
                height: 70px;
            }
            
            .control-btn.primary {
                width: 85px;
                height: 85px;
            }
            
            .notification {
                left: 1rem;
                right: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h1 class="loading-title">VOZ DEL SHADDAI</h1>
            <p class="loading-subtitle">Inicializando sistema de radio...</p>
            <div id="loading-details" style="color: var(--gray); margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-cross"></i>
                </div>
                <div class="logo-text">
                    <h1>VOZ DEL SHADDAI</h1>
                    <p>Radio Cristiana 24/7</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--gray);">Estado</div>
                    <div id="connection-status" style="font-weight: 600; color: var(--success);">
                        <i class="fas fa-circle"></i> Conectado
                    </div>
                </div>
            </div>
        </header>

        <!-- Visualizer -->
        <div class="visualizer-section">
            <div class="visualizer-title">
                <i class="fas fa-wave-square"></i> Espectro Musical
            </div>
            <div class="visualizer-container">
                <canvas id="visualizer-canvas"></canvas>
            </div>
        </div>

        <!-- Now Playing -->
        <div class="now-playing">
            <div class="track-display">
                <div class="album-art">
                    <i class="fas fa-music"></i>
                </div>
                <div class="track-info">
                    <h2 class="track-title" id="track-title">Cargando m칰sica...</h2>
                    <p class="track-artist" id="track-artist">Voz del Shaddai Radio</p>
                    <div class="track-meta">
                        <span id="current-time">00:00</span>
                        <span id="total-time">00:00</span>
                        <span id="bitrate">128 kbps</span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-time">
                    <span id="progress-current">00:00</span>
                    <span id="progress-total">00:00</span>
                </div>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="controls-container">
            <div class="main-controls">
                <button class="control-btn" id="prev-btn" title="Canci칩n anterior">
                    <i class="fas fa-step-backward"></i>
                </button>
                
                <button class="control-btn primary" id="play-btn" title="Reproducir/Pausar">
                    <i class="fas fa-play"></i>
                </button>
                
                <button class="control-btn" id="next-btn" title="Siguiente canci칩n">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>

            <!-- Secondary Controls -->
            <div class="secondary-controls">
                <button class="secondary-btn" id="shuffle-btn" title="Modo aleatorio">
                    <i class="fas fa-random"></i> Aleatorio
                </button>
                
                <button class="secondary-btn" id="repeat-btn" title="Modo repetici칩n">
                    <i class="fas fa-redo"></i> Repetir
                </button>
                
                <button class="secondary-btn" id="refresh-btn" title="Recargar lista">
                    <i class="fas fa-sync-alt"></i> Recargar
                </button>
            </div>
        </div>

        <!-- Volume -->
        <div class="volume-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <h3 style="color: var(--primary-light);">Volumen</h3>
                <span id="volume-value" style="font-weight: 600;">70%</span>
            </div>
            <div class="volume-control">
                <i class="fas fa-volume-down"></i>
                <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
                <i class="fas fa-volume-up"></i>
            </div>
        </div>

        <!-- Playlist -->
        <div class="playlist-section">
            <div class="playlist-header">
                <h3 class="playlist-title">Lista de Reproducci칩n</h3>
                <span id="playlist-count" style="background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: var(--radius);">0 canciones</span>
            </div>
            <div class="playlist" id="playlist">
                <!-- Las canciones se cargar치n aqu칤 -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <div>
            <strong id="notification-title">Notificaci칩n</strong>
            <p id="notification-message">Mensaje de notificaci칩n</p>
        </div>
    </div>

    <script>
        // ============== SISTEMA COMPLETO 100% FUNCIONAL ==============
        class RadioPlayerSystem {
            constructor() {
                // CONFIGURACI칍N PRINCIPAL - TUS DATOS DE GITHUB
                this.config = {
                    githubUser: 'cl7adv',
                    repo: 'Voz-del-Shaddai-Online',
                    branch: 'main',
                    musicFolder: 'musica',
                    
                    // M칔LTIPLES FUENTES DE FALLBACK (en orden de prioridad)
                    sources: [
                        // 1. GitHub Pages Directo (el m치s confiable si tienes GitHub Pages)
                        (user, repo, branch, folder, file) => 
                            `https://${user}.github.io/${repo}/${folder}/${encodeURIComponent(file)}`,
                        
                        // 2. jsDelivr CDN (muy confiable)
                        (user, repo, branch, folder, file) => 
                            `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${folder}/${encodeURIComponent(file)}`,
                        
                        // 3. Statically CDN (alternativa buena)
                        (user, repo, branch, folder, file) => 
                            `https://cdn.statically.io/gh/${user}/${repo}/${branch}/${folder}/${encodeURIComponent(file)}`,
                        
                        // 4. RawGit (alternativa)
                        (user, repo, branch, folder, file) => 
                            `https://rawcdn.githack.com/${user}/${repo}/${branch}/${folder}/${encodeURIComponent(file)}`,
                        
                        // 5. GitHub Raw (칰ltimo recurso)
                        (user, repo, branch, folder, file) => 
                            `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${folder}/${encodeURIComponent(file)}`
                    ],
                    
                    // Formatos soportados
                    supportedFormats: ['mp3', 'm4a', 'wav', 'ogg', 'flac', 'mp4'],
                    
                    // Configuraci칩n del reproductor
                    defaultVolume: 0.7,
                    autoPlay: true,
                    shuffleOnStart: false,
                    maxRetries: 3
                };

                // ESTADO DEL SISTEMA
                this.state = {
                    tracks: [],
                    currentTrackIndex: 0,
                    isPlaying: false,
                    isShuffled: false,
                    repeatMode: 'none', // none, one, all
                    volume: this.config.defaultVolume,
                    currentSource: 0,
                    isLoading: false,
                    audioContext: null,
                    analyser: null,
                    sourceNode: null,
                    dataArray: null,
                    animationFrame: null,
                    retryCount: 0
                };

                // ELEMENTOS DOM
                this.elements = {};
                this.audio = new Audio();
                this.audio.crossOrigin = "anonymous"; // IMPORTANTE para CORS
                this.audio.volume = this.state.volume;
                
                // Canvas para visualizador
                this.canvas = null;
                this.ctx = null;
                
                // Inicializar TODO
                this.init();
            }

            // ============== INICIALIZACI칍N ==============
            async init() {
                this.cacheElements();
                this.setupEventListeners();
                this.setupAudioEvents();
                this.initVisualizer();
                await this.loadTracks();
                this.hideLoadingScreen();
            }

            cacheElements() {
                this.elements = {
                    // Loading
                    loadingScreen: document.getElementById('loading-screen'),
                    loadingDetails: document.getElementById('loading-details'),
                    
                    // App
                    app: document.getElementById('app'),
                    
                    // Track info
                    trackTitle: document.getElementById('track-title'),
                    trackArtist: document.getElementById('track-artist'),
                    
                    // Progress
                    progressFill: document.getElementById('progress-fill'),
                    progressBar: document.getElementById('progress-bar'),
                    progressCurrent: document.getElementById('progress-current'),
                    progressTotal: document.getElementById('progress-total'),
                    currentTime: document.getElementById('current-time'),
                    totalTime: document.getElementById('total-time'),
                    
                    // Controls
                    playBtn: document.getElementById('play-btn'),
                    prevBtn: document.getElementById('prev-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    shuffleBtn: document.getElementById('shuffle-btn'),
                    repeatBtn: document.getElementById('repeat-btn'),
                    refreshBtn: document.getElementById('refresh-btn'),
                    
                    // Volume
                    volumeSlider: document.getElementById('volume-slider'),
                    volumeValue: document.getElementById('volume-value'),
                    
                    // Playlist
                    playlist: document.getElementById('playlist'),
                    playlistCount: document.getElementById('playlist-count'),
                    
                    // Connection
                    connectionStatus: document.getElementById('connection-status'),
                    
                    // Visualizer
                    visualizerCanvas: document.getElementById('visualizer-canvas'),
                    
                    // Notification
                    notification: document.getElementById('notification'),
                    notificationTitle: document.getElementById('notification-title'),
                    notificationMessage: document.getElementById('notification-message')
                };
            }

            setupEventListeners() {
                // Controles principales
                this.elements.playBtn.addEventListener('click', () => this.togglePlay());
                this.elements.prevBtn.addEventListener('click', () => this.previousTrack());
                this.elements.nextBtn.addEventListener('click', () => this.nextTrack());
                this.elements.shuffleBtn.addEventListener('click', () => this.toggleShuffle());
                this.elements.repeatBtn.addEventListener('click', () => this.toggleRepeat());
                this.elements.refreshBtn.addEventListener('click', () => this.refreshTracks());
                
                // Volumen
                this.elements.volumeSlider.addEventListener('input', (e) => {
                    this.setVolume(e.target.value / 100);
                });
                
                // Barra de progreso
                this.elements.progressBar.addEventListener('click', (e) => {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const percentage = (e.clientX - rect.left) / rect.width;
                    this.seek(percentage);
                });
                
                // Atajos de teclado
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT') return;
                    
                    switch(e.code) {
                        case 'Space':
                            e.preventDefault();
                            this.togglePlay();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.nextTrack();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.previousTrack();
                            break;
                        case 'KeyM':
                            e.preventDefault();
                            this.toggleMute();
                            break;
                        case 'KeyS':
                            e.preventDefault();
                            this.toggleShuffle();
                            break;
                        case 'KeyR':
                            e.preventDefault();
                            this.toggleRepeat();
                            break;
                    }
                });
            }

            setupAudioEvents() {
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => this.onTrackLoaded());
                this.audio.addEventListener('ended', () => this.onTrackEnded());
                this.audio.addEventListener('error', (e) => this.onAudioError(e));
                this.audio.addEventListener('play', () => this.onPlay());
                this.audio.addEventListener('pause', () => this.onPause());
                this.audio.addEventListener('canplay', () => this.onCanPlay());
                this.audio.addEventListener('stalled', () => this.onStalled());
                this.audio.addEventListener('waiting', () => this.onWaiting());
            }

            // ============== VISUALIZADOR ==============
            initVisualizer() {
                this.canvas = this.elements.visualizerCanvas;
                this.ctx = this.canvas.getContext('2d');
                
                // Configurar tama침o
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }

            initAudioAnalyser() {
                try {
                    // Crear AudioContext
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.state.analyser = this.state.audioContext.createAnalyser();
                    
                    // Crear source desde el elemento audio
                    this.state.sourceNode = this.state.audioContext.createMediaElementSource(this.audio);
                    
                    // Conectar
                    this.state.sourceNode.connect(this.state.analyser);
                    this.state.analyser.connect(this.state.audioContext.destination);
                    
                    // Configurar analizador
                    this.state.analyser.fftSize = 256;
                    const bufferLength = this.state.analyser.frequencyBinCount;
                    this.state.dataArray = new Uint8Array(bufferLength);
                    
                } catch (error) {
                    console.warn('No se pudo inicializar el analizador de audio:', error);
                }
            }

            startVisualizer() {
                if (!this.state.analyser || !this.state.dataArray) {
                    this.initAudioAnalyser();
                }
                
                if (this.state.animationFrame) {
                    cancelAnimationFrame(this.state.animationFrame);
                }
                
                const draw = () => {
                    this.state.animationFrame = requestAnimationFrame(draw);
                    
                    if (!this.state.analyser || !this.state.dataArray) return;
                    
                    // Obtener datos de frecuencia
                    this.state.analyser.getByteFrequencyData(this.state.dataArray);
                    
                    // Limpiar canvas
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Dibujar barras
                    this.drawFrequencyBars();
                };
                
                draw();
            }

            drawFrequencyBars() {
                const width = this.canvas.width;
                const height = this.canvas.height;
                const barWidth = (width / this.state.dataArray.length) * 2.5;
                let barHeight;
                let x = 0;
                
                for(let i = 0; i < this.state.dataArray.length; i++) {
                    barHeight = this.state.dataArray[i] / 2;
                    
                    // Crear gradiente
                    const gradient = this.ctx.createLinearGradient(0, height, 0, height - barHeight);
                    gradient.addColorStop(0, '#4361ee');
                    gradient.addColorStop(0.5, '#4cc9f0');
                    gradient.addColorStop(1, '#7209b7');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }

            // ============== CARGA DE M칔SICA DESDE GITHUB ==============
            async loadTracks() {
                try {
                    this.updateLoadingStatus('Conectando con GitHub...');
                    this.elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Conectando...';
                    
                    // URL de la API de GitHub para listar archivos
                    const apiUrl = `https://api.github.com/repos/${this.config.githubUser}/${this.config.repo}/contents/${this.config.musicFolder}`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.updateLoadingStatus('Obteniendo lista de archivos...');
                    
                    const files = await response.json();
                    
                    // Filtrar solo archivos de audio
                    this.state.tracks = files
                        .filter(file => {
                            // Solo archivos, no carpetas
                            if (file.type !== 'file') return false;
                            
                            // Verificar extensi칩n
                            const ext = file.name.toLowerCase().split('.').pop();
                            return this.config.supportedFormats.includes(ext);
                        })
                        .map((file, index) => ({
                            id: index + 1,
                            name: file.name,
                            size: file.size,
                            type: file.name.split('.').pop().toLowerCase(),
                            url: '', // Se llenar치 din치micamente
                            duration: 0,
                            played: false,
                            lastModified: file.sha // Usar SHA como identificador 칰nico
                        }));
                    
                    if (this.state.tracks.length === 0) {
                        throw new Error('No se encontraron archivos de audio en la carpeta /musica/');
                    }
                    
                    this.updateLoadingStatus(`Procesando ${this.state.tracks.length} canciones...`);
                    
                    // Actualizar UI
                    this.updateTrackCount();
                    this.updatePlaylist();
                    this.elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Conectado';
                    this.elements.connectionStatus.style.color = 'var(--success)';
                    
                    // Si hay canciones, cargar la primera
                    if (this.state.tracks.length > 0) {
                        this.updateLoadingStatus('Cargando primera canci칩n...');
                        
                        // Configurar shuffle si est치 activado
                        if (this.config.shuffleOnStart) {
                            this.state.currentTrackIndex = Math.floor(Math.random() * this.state.tracks.length);
                            this.state.isShuffled = true;
                            this.elements.shuffleBtn.classList.add('active');
                        }
                        
                        // Cargar la primera canci칩n
                        await this.loadTrack(this.state.currentTrackIndex);
                    }
                    
                    this.updateLoadingStatus('Sistema listo');
                    this.showNotification('춰Listo!', `${this.state.tracks.length} canciones cargadas`, 'success');
                    
                } catch (error) {
                    console.error('Error cargando canciones:', error);
                    
                    // Actualizar estado de conexi칩n
                    this.elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Error';
                    this.elements.connectionStatus.style.color = 'var(--danger)';
                    
                    // Mostrar error detallado
                    let errorMessage = error.message;
                    if (error.message.includes('404')) {
                        errorMessage = 'No se encontr칩 la carpeta /musica/ en GitHub';
                    } else if (error.message.includes('403')) {
                        errorMessage = 'L칤mite de API de GitHub alcanzado. Intenta m치s tarde.';
                    }
                    
                    this.showNotification('Error de conexi칩n', errorMessage, 'error');
                    
                    // Intentar m칠todo alternativo
                    await this.tryAlternativeLoading();
                }
            }

            async tryAlternativeLoading() {
                try {
                    this.updateLoadingStatus('Intentando m칠todo alternativo...');
                    
                    // Intentar cargar una lista de archivos conocidos
                    const knownFiles = [
                        'A Cristo sea la gloria.mp3',
                        'Amor divino.mp3',
                        // A침ade aqu칤 m치s nombres de archivos si los conoces
                    ];
                    
                    this.state.tracks = knownFiles
                        .map((name, index) => ({
                            id: index + 1,
                            name: name,
                            size: 0,
                            type: 'mp3',
                            url: '',
                            duration: 0,
                            played: false
                        }))
                        .filter(track => track.name); // Filtrar nombres vac칤os
                    
                    if (this.state.tracks.length > 0) {
                        this.updateLoadingStatus(`Encontradas ${this.state.tracks.length} canciones`);
                        this.updateTrackCount();
                        this.updatePlaylist();
                        await this.loadTrack(0);
                    } else {
                        throw new Error('No se pudieron cargar canciones');
                    }
                    
                } catch (error) {
                    console.error('Error en m칠todo alternativo:', error);
                    this.showNotification('Error cr칤tico', 'No se pudo cargar m칰sica. Verifica tu conexi칩n.', 'error');
                }
            }

            // ============== SISTEMA DE URLS INTELIGENTE ==============
            getTrackUrl(trackName) {
                // Intentar con la fuente actual
                const sourceFunc = this.config.sources[this.state.currentSource];
                let url = sourceFunc(
                    this.config.githubUser,
                    this.config.repo,
                    this.config.branch,
                    this.config.musicFolder,
                    trackName
                );
                
                // Codificar caracteres especiales correctamente
                url = this.fixUrlEncoding(url);
                
                return url;
            }

            fixUrlEncoding(url) {
                // Decodificar primero para evitar doble encoding
                try {
                    url = decodeURIComponent(url);
                } catch (e) {
                    // Ignorar si ya est치 bien formada
                }
                
                // Codificar solo los caracteres problem치ticos
                return encodeURI(url).replace(/'/g, '%27').replace(/"/g, '%22');
            }

            async testUrl(url) {
                return new Promise((resolve) => {
                    const testAudio = new Audio();
                    testAudio.preload = 'metadata';
                    testAudio.src = url;
                    
                    testAudio.addEventListener('loadedmetadata', () => {
                        resolve({ success: true, url });
                    });
                    
                    testAudio.addEventListener('error', () => {
                        resolve({ success: false, url });
                    });
                    
                    setTimeout(() => {
                        resolve({ success: false, url });
                    }, 3000);
                });
            }

            // ============== REPRODUCCI칍N ==============
            async loadTrack(index) {
                if (index < 0 || index >= this.state.tracks.length) {
                    console.error('칈ndice fuera de rango:', index);
                    return;
                }
                
                this.state.currentTrackIndex = index;
                const track = this.state.tracks[index];
                
                try {
                    this.state.isLoading = true;
                    this.updatePlayButton();
                    this.elements.trackTitle.textContent = this.formatTrackName(track.name);
                    this.elements.trackArtist.textContent = 'Voz del Shaddai';
                    
                    // Detener reproducci칩n actual
                    if (this.state.isPlaying) {
                        this.audio.pause();
                    }
                    
                    // Detener visualizador
                    if (this.state.animationFrame) {
                        cancelAnimationFrame(this.state.animationFrame);
                        this.state.animationFrame = null;
                    }
                    
                    // Reiniciar contador de reintentos
                    this.state.retryCount = 0;
                    
                    // Obtener URL y cargar
                    await this.loadTrackWithFallback(track);
                    
                    this.state.isLoading = false;
                    
                } catch (error) {
                    console.error('Error cargando track:', error);
                    this.showNotification('Error', `No se pudo cargar: ${track.name}`, 'error');
                    
                    // Intentar siguiente canci칩n
                    setTimeout(() => this.nextTrack(), 2000);
                }
            }

            async loadTrackWithFallback(track) {
                const maxAttempts = this.config.sources.length * this.config.maxRetries;
                let attempts = 0;
                
                while (attempts < maxAttempts) {
                    // Obtener URL de la fuente actual
                    const url = this.getTrackUrl(track.name);
                    
                    try {
                        console.log(`Intentando cargar desde: ${url}`);
                        
                        // Asignar URL al audio
                        this.audio.src = url;
                        this.audio.load();
                        
                        // Esperar a que cargue
                        await new Promise((resolve, reject) => {
                            const onLoaded = () => {
                                this.audio.removeEventListener('canplay', onLoaded);
                                this.audio.removeEventListener('error', onError);
                                resolve();
                            };
                            
                            const onError = (e) => {
                                this.audio.removeEventListener('canplay', onLoaded);
                                this.audio.removeEventListener('error', onError);
                                reject(new Error('Error de carga'));
                            };
                            
                            this.audio.addEventListener('canplay', onLoaded);
                            this.audio.addEventListener('error', onError);
                            
                            // Timeout
                            setTimeout(() => {
                                this.audio.removeEventListener('canplay', onLoaded);
                                this.audio.removeEventListener('error', onError);
                                reject(new Error('Timeout'));
                            }, 10000);
                        });
                        
                        // Si llegamos aqu칤, la carga fue exitosa
                        track.url = url;
                        
                        // Reproducir autom치ticamente
                        if (this.config.autoPlay) {
                            await this.play();
                        }
                        
                        return; // Salir del bucle, 칠xito
                        
                    } catch (error) {
                        console.warn(`Intento ${attempts + 1} fall칩:`, error);
                        attempts++;
                        
                        // Cambiar a siguiente fuente
                        this.state.currentSource = (this.state.currentSource + 1) % this.config.sources.length;
                        
                        // Esperar un poco antes del siguiente intento
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                throw new Error(`No se pudo cargar despu칠s de ${maxAttempts} intentos`);
            }

            async play() {
                try {
                    // Si el AudioContext est치 suspendido, reanudarlo
                    if (this.state.audioContext && this.state.audioContext.state === 'suspended') {
                        await this.state.audioContext.resume();
                    }
                    
                    await this.audio.play();
                    this.state.isPlaying = true;
                    this.updatePlayButton();
                    
                    // Iniciar visualizador
                    this.startVisualizer();
                    
                    this.showNotification('Reproduciendo', this.formatTrackName(this.state.tracks[this.state.currentTrackIndex].name), 'success');
                    
                } catch (error) {
                    console.error('Error reproduciendo:', error);
                    this.state.isPlaying = false;
                    this.updatePlayButton();
                    
                    if (error.name === 'NotAllowedError') {
                        this.showNotification('Haz clic en play', 'El navegador requiere interacci칩n para reproducir', 'warning');
                    } else if (error.name === 'NotSupportedError') {
                        this.showNotification('Formato no compatible', 'Intentando otra fuente...', 'error');
                        this.nextTrack();
                    }
                }
            }

            pause() {
                this.audio.pause();
                this.state.isPlaying = false;
                this.updatePlayButton();
                
                // Detener visualizador
                if (this.state.animationFrame) {
                    cancelAnimationFrame(this.state.animationFrame);
                    this.state.animationFrame = null;
                }
            }

            togglePlay() {
                if (!this.audio.src) {
                    if (this.state.tracks.length > 0) {
                        this.loadTrack(this.state.currentTrackIndex);
                    }
                    return;
                }
                
                if (this.state.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            nextTrack() {
                if (this.state.tracks.length === 0) return;
                
                let nextIndex;
                
                if (this.state.isShuffled) {
                    nextIndex = this.getRandomTrackIndex();
                } else {
                    nextIndex = (this.state.currentTrackIndex + 1) % this.state.tracks.length;
                }
                
                this.loadTrack(nextIndex);
            }

            previousTrack() {
                if (this.state.tracks.length === 0) return;
                
                let prevIndex;
                
                if (this.state.isShuffled) {
                    prevIndex = this.getRandomTrackIndex();
                } else {
                    prevIndex = (this.state.currentTrackIndex - 1 + this.state.tracks.length) % this.state.tracks.length;
                }
                
                this.loadTrack(prevIndex);
            }

            getRandomTrackIndex() {
                if (this.state.tracks.length <= 1) return 0;
                
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * this.state.tracks.length);
                } while (newIndex === this.state.currentTrackIndex && this.state.tracks.length > 1);
                return newIndex;
            }

            seek(percentage) {
                if (this.audio.duration) {
                    this.audio.currentTime = percentage * this.audio.duration;
                }
            }

            setVolume(value) {
                this.state.volume = value;
                this.audio.volume = value;
                this.elements.volumeSlider.value = value * 100;
                this.elements.volumeValue.textContent = `${Math.round(value * 100)}%`;
            }

            toggleMute() {
                if (this.audio.volume > 0) {
                    this.setVolume(0);
                } else {
                    this.setVolume(this.config.defaultVolume);
                }
            }

            toggleShuffle() {
                this.state.isShuffled = !this.state.isShuffled;
                this.elements.shuffleBtn.classList.toggle('active', this.state.isShuffled);
                
                this.showNotification(
                    'Modo aleatorio',
                    this.state.isShuffled ? 'Activado' : 'Desactivado',
                    'info'
                );
            }

            toggleRepeat() {
                const modes = ['none', 'one', 'all'];
                const currentIndex = modes.indexOf(this.state.repeatMode);
                this.state.repeatMode = modes[(currentIndex + 1) % modes.length];
                
                this.audio.loop = this.state.repeatMode === 'one';
                
                const modeNames = ['Sin repetici칩n', 'Repetir una', 'Repetir todas'];
                const modeText = modeNames[(currentIndex + 1) % modeNames.length];
                
                this.elements.repeatBtn.innerHTML = `<i class="fas fa-redo"></i> ${modeText}`;
                this.elements.repeatBtn.classList.toggle('active', this.state.repeatMode !== 'none');
                
                this.showNotification('Modo repetir', modeText, 'info');
            }

            // ============== ACTUALIZACI칍N DE UI ==============
            updateProgress() {
                if (!this.audio.duration || isNaN(this.audio.duration)) return;
                
                const current = this.audio.currentTime;
                const duration = this.audio.duration;
                const percentage = (current / duration) * 100;
                
                // Actualizar barra de progreso
                this.elements.progressFill.style.width = `${percentage}%`;
                
                // Actualizar tiempos
                const currentStr = this.formatTime(current);
                const durationStr = this.formatTime(duration);
                
                this.elements.currentTime.textContent = currentStr;
                this.elements.totalTime.textContent = durationStr;
                this.elements.progressCurrent.textContent = currentStr;
                this.elements.progressTotal.textContent = durationStr;
            }

            updatePlayButton() {
                const icon = this.state.isPlaying ? 'fa-pause' : 'fa-play';
                this.elements.playBtn.innerHTML = `<i class="fas ${icon}"></i>`;
            }

            updatePlaylist() {
                this.elements.playlist.innerHTML = '';
                
                this.state.tracks.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = `playlist-item ${index === this.state.currentTrackIndex ? 'active' : ''}`;
                    item.innerHTML = `
                        <div style="width: 30px; text-align: center; color: var(--gray);">${index + 1}</div>
                        <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${this.formatTrackName(track.name)}
                        </div>
                        <div style="color: var(--gray); font-size: 0.9rem;">
                            ${this.formatFileSize(track.size)}
                        </div>
                    `;
                    
                    item.addEventListener('click', () => this.loadTrack(index));
                    this.elements.playlist.appendChild(item);
                });
            }

            updateTrackCount() {
                this.elements.playlistCount.textContent = `${this.state.tracks.length} canciones`;
            }

            updateLoadingStatus(message) {
                if (this.elements.loadingDetails) {
                    this.elements.loadingDetails.textContent = message;
                }
            }

            formatTrackName(name) {
                // Remover extensi칩n y limitar longitud
                const withoutExt = name.replace(/\.[^/.]+$/, '');
                return withoutExt.length > 40 ? withoutExt.substring(0, 40) + '...' : withoutExt;
            }

            formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '00:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            formatFileSize(bytes) {
                if (!bytes) return '';
                const mb = bytes / (1024 * 1024);
                return `${mb.toFixed(1)} MB`;
            }

            // ============== EVENT HANDLERS ==============
            onTrackLoaded() {
                const track = this.state.tracks[this.state.currentTrackIndex];
                if (this.audio.duration && !isNaN(this.audio.duration)) {
                    track.duration = this.audio.duration;
                }
            }

            onTrackEnded() {
                switch (this.state.repeatMode) {
                    case 'one':
                        this.audio.currentTime = 0;
                        this.play();
                        break;
                    case 'all':
                        this.nextTrack();
                        break;
                    case 'none':
                    default:
                        if (this.state.currentTrackIndex < this.state.tracks.length - 1) {
                            this.nextTrack();
                        } else {
                            this.pause();
                        }
                        break;
                }
            }

            onAudioError(error) {
                console.error('Error de audio:', error);
                
                // Incrementar contador de reintentos
                this.state.retryCount++;
                
                if (this.state.retryCount < this.config.maxRetries) {
                    // Intentar con siguiente fuente
                    this.state.currentSource = (this.state.currentSource + 1) % this.config.sources.length;
                    this.showNotification('Reintentando', 'Probando otra fuente...', 'warning');
                    
                    // Recargar la misma canci칩n con nueva fuente
                    setTimeout(() => {
                        this.loadTrack(this.state.currentTrackIndex);
                    }, 1000);
                } else {
                    // Demasiados intentos, siguiente canci칩n
                    this.showNotification('Error', 'Saltando a siguiente canci칩n', 'error');
                    setTimeout(() => this.nextTrack(), 2000);
                }
            }

            onCanPlay() {
                console.log('Audio listo para reproducir');
                this.elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Reproduciendo';
                this.elements.connectionStatus.style.color = 'var(--success)';
            }

            onStalled() {
                console.warn('Audio se estanc칩, reintentando...');
                this.showNotification('Buffering', 'Recuperando conexi칩n...', 'warning');
            }

            onWaiting() {
                console.log('Audio esperando datos...');
            }

            onPlay() {
                this.state.isPlaying = true;
                this.updatePlayButton();
            }

            onPause() {
                this.state.isPlaying = false;
                this.updatePlayButton();
            }

            // ============== NOTIFICACIONES ==============
            showNotification(title, message, type = 'info') {
                this.elements.notificationTitle.textContent = title;
                this.elements.notificationMessage.textContent = message;
                
                // Establecer color seg칰n tipo
                let color = 'var(--primary)';
                if (type === 'success') color = 'var(--success)';
                if (type === 'error') color = 'var(--danger)';
                if (type === 'warning') color = 'var(--warning)';
                
                this.elements.notification.style.borderLeftColor = color;
                
                // Mostrar
                this.elements.notification.classList.add('show');
                
                // Ocultar despu칠s de 3 segundos
                setTimeout(() => {
                    this.elements.notification.classList.remove('show');
                }, 3000);
            }

            // ============== UTILIDADES ==============
            hideLoadingScreen() {
                setTimeout(() => {
                    this.elements.loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        this.elements.loadingScreen.style.display = 'none';
                        this.elements.app.style.display = 'block';
                        
                        // Animaci칩n de entrada
                        setTimeout(() => {
                            this.elements.app.classList.add('app-loaded');
                        }, 50);
                        
                    }, 500);
                }, 1000);
            }

            async refreshTracks() {
                this.showNotification('Actualizando', 'Recargando lista de canciones...', 'info');
                await this.loadTracks();
            }

            // ============== DEBUG ==============
            debugInfo() {
                console.log('=== DEBUG INFO ===');
                console.log('Tracks cargadas:', this.state.tracks.length);
                console.log('Track actual:', this.state.currentTrackIndex);
                console.log('Fuente actual:', this.state.currentSource);
                console.log('URL actual:', this.audio.src);
                console.log('Estado:', this.state.isPlaying ? 'Reproduciendo' : 'Pausado');
                console.log('Volumen:', this.state.volume);
                console.log('==================');
            }
        }

        // ============== INICIAR APLICACI칍N ==============
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar sistema
            window.radioSystem = new RadioPlayerSystem();
            
            // Para depuraci칩n
            window.debugRadio = () => window.radioSystem.debugInfo();
            
            // Mostrar instrucciones despu칠s de cargar
            setTimeout(() => {
                if (window.radioSystem.state.tracks.length > 0) {
                    window.radioSystem.showNotification(
                        '춰Controles activos!',
                        'Usa las flechas   para navegar, ESPACIO para play/pause',
                        'info'
                    );
                }
            }, 4000);
        });

        // ============== FUNCIONES GLOBALES ==============
        function shareRadio() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'Voz del Shaddai Radio',
                    text: 'Escucha m칰sica cristiana las 24 horas',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                window.radioSystem?.showNotification('Enlace copiado', 'Comparte la radio con otros', 'success');
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
