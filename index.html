<script>
    const usuario = "cl7adv";
    const repo = "Voz-del-Shaddai-Online";
    const carpeta = "musica";

    let listaMusica = [];
    let indiceActual = 0;
    const audio = new Audio();
    
    const status = document.getElementById('status');
    const playBtn = document.getElementById('playBtn');
    const radioBody = document.getElementById('radioBody');
    const intro = document.getElementById('intro-overlay');

    async function obtenerMusica() {
        const url = `https://api.github.com/repos/${usuario}/${repo}/contents/${carpeta}`;
        try {
            const response = await fetch(url);
            const archivos = await response.json();
            
            listaMusica = archivos.filter(file => file.name.match(/\.(mp3|m4a|mp4|wav)$/i));
            
            if (listaMusica.length > 0) {
                status.innerText = "SISTEMA LISTO\n" + listaMusica.length + " AUDIOS";
                indiceActual = Math.floor(Math.random() * listaMusica.length);
            } else {
                status.innerText = "CARPETA VACÍA";
            }
        } catch (e) {
            status.innerText = "ERROR DE CONEXIÓN";
        }
    }

    function reproducir() {
        if (listaMusica.length === 0) return;
        
        const tema = listaMusica[indiceActual];

        const urlJsDelivr = `https://cdn.jsdelivr.net/gh/${usuario}/${repo}/${carpeta}/${tema.name}`;

        audio.src = urlJsDelivr;
        audio.load();
        
        audio.play().then(() => {
            status.innerText = "EN VIVO:\n" + tema.name.slice(0, 30);
            playBtn.innerText = "⏸";
        }).catch(error => {
            console.error("Fallo de audio:", error);
            status.innerText = "ERROR DE CARGA...\nSALTANDO TEMA";
            setTimeout(siguienteTema, 1000);
        });
    }

    function siguienteTema() {
        indiceActual = (indiceActual + 1) % listaMusica.length;
        reproducir();
    }

    function anteriorTema() {
        indiceActual = (indiceActual - 1 + listaMusica.length) % listaMusica.length;
        reproducir();
    }

    audio.onended = siguienteTema;

    document.getElementById('startBtn').onclick = () => {
        intro.style.opacity = '0';
        setTimeout(() => {
            intro.style.visibility = 'hidden';
            radioBody.classList.add('radio-visible');
            reproducir();
        }, 600);
    };

    playBtn.onclick = () => {
        if (audio.paused) {
            if (!audio.src) reproducir();
            else audio.play();
            playBtn.innerText = "⏸";
        } else {
            audio.pause();
            playBtn.innerText = "▶";
            status.innerText = "PAUSA";
        }
    };

    document.getElementById('nextBtn').onclick = siguienteTema;
    document.getElementById('prevBtn').onclick = anteriorTema;
    document.getElementById('volume').oninput = (e) => audio.volume = e.target.value;

    obtenerMusica();
</script>
