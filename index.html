<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìª Voz del Shaddai Radio - Emisora Online Continua</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="üìª Emisora Cristiana Online - Reproducci√≥n continua sin interrupciones. Crossfade profesional para una experiencia perfecta.">
    
    <!-- Estilos y Fuentes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon en base64 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìª</text></svg>">
    
    <style>
        /* [TODO: EL CSS COMPLETO SE MANTIENE IGUAL - POR FAVOR CONSERVA TODO EL CSS ANTERIOR] */
        /* Para ahorrar espacio, no repito todo el CSS aqu√≠, pero debe estar presente */
        
        /* Solo a√±ado una nueva clase para el modo fallback */
        .fallback-mode {
            background: rgba(251, 188, 5, 0.1);
            border: 2px solid var(--accent);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h1 style="font-family: 'Montserrat', sans-serif; font-size: 2.5rem; color: white; margin-bottom: 1rem;">
                VOZ DEL SHADDAI
            </h1>
            <p style="color: var(--gray); margin-bottom: 2rem;">Iniciando emisora online...</p>
            <div id="loading-details" style="color: var(--gray);"></div>
        </div>
    </div>

    <!-- Interaction Required Message -->
    <div id="interaction-message" class="interaction-message" style="display: none;">
        <div class="interaction-content">
            <div class="interaction-icon">
                <i class="fas fa-hand-pointer"></i>
            </div>
            <h2>¬°Interacci√≥n Requerida!</h2>
            <p>Para cumplir con las pol√≠ticas de los navegadores modernos, necesitas interactuar con la p√°gina para iniciar la reproducci√≥n de audio.</p>
            <p>Por favor, haz clic en el bot√≥n de abajo para activar la radio:</p>
            <button class="interaction-btn" id="enable-audio-btn">
                <i class="fas fa-play-circle"></i>
                ACTIVAR REPRODUCCI√ìN
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Header -->
        <header class="radio-header">
            <div class="radio-brand">
                <div class="radio-logo">
                    <i class="fas fa-broadcast-tower"></i>
                </div>
                <div class="radio-info">
                    <h1>VOZ DEL SHADDAI RADIO</h1>
                    <p class="radio-tagline">Emisora Cristiana Online - Reproducci√≥n Continua</p>
                    <div class="status-indicator status-offline" id="broadcast-status">
                        <i class="fas fa-circle" style="font-size: 0.8rem;"></i>
                        <span>ESPERANDO INTERACCI√ìN</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Broadcast Info -->
        <section class="broadcast-info">
            <div style="font-size: 1.1rem; color: var(--gray); margin-bottom: 0.5rem;">
                <i class="fas fa-satellite-dish"></i> Emisora Online - Solo Escucha
            </div>
            <div class="broadcast-stats">
                <div class="stat-item">
                    <div class="stat-label">CANCIONES EN LISTA</div>
                    <div class="stat-value" id="total-tracks">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">TIEMPO TRANSMITIENDO</div>
                    <div class="stat-value" id="broadcast-time">00:00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">PR√ìXIMA CANCI√ìN</div>
                    <div class="stat-value" id="next-in">--:--</div>
                </div>
            </div>
        </section>

        <!-- Now Playing -->
        <section class="now-playing-card">
            <div class="track-display">
                <div class="album-art-container">
                    <div class="album-art" id="album-art">
                        <i class="fas fa-music"></i>
                    </div>
                </div>
                <div class="track-info">
                    <h2 class="track-title" id="track-title">Haz clic en "Activar Radio"</h2>
                    <p class="track-artist" id="track-artist">
                        Voz del Shaddai Radio
                    </p>
                    <div class="track-meta">
                        <span id="current-time">00:00</span>
                        <span id="track-duration">00:00</span>
                        <span id="time-remaining">-00:00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Crossfade Indicator -->
        <section class="crossfade-section">
            <div class="crossfade-title">
                <i class="fas fa-exchange-alt"></i> Transici√≥n Autom√°tica
            </div>
            <div class="crossfade-info">
                <span id="current-fade-status">Esperando activaci√≥n...</span>
                <span id="fade-duration">Duraci√≥n: 4 segundos</span>
            </div>
            <div class="crossfade-bar">
                <div class="crossfade-progress" id="crossfade-progress"></div>
            </div>
            <div class="crossfade-labels">
                <span>Canci√≥n actual</span>
                <span id="fade-percentage">0%</span>
                <span>Siguiente canci√≥n</span>
            </div>
        </section>

        <!-- Progress Bar -->
        <section class="progress-section">
            <div class="progress-info">
                <span id="progress-current">00:00</span>
                <span id="progress-total">00:00</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--gray);">
                <span id="next-change">Activa la radio para comenzar la reproducci√≥n</span>
            </div>
        </section>

        <!-- Radio Controls -->
        <section class="radio-controls">
            <div class="controls-group">
                <div class="power-section">
                    <button class="power-btn off" id="power-btn" title="Encender/Apagar radio">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <span style="color: var(--gray); font-size: 1rem;">PRIMERO ACTIVA LA RADIO</span>
                </div>
                
                <div class="volume-section">
                    <div class="volume-display">
                        <div class="volume-icon">
                            <i class="fas fa-volume-up" id="volume-icon"></i>
                        </div>
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
                        <div class="volume-value" id="volume-value">70%</div>
                    </div>
                    <span style="color: var(--gray); font-size: 1rem; text-align: center; display: block;">CONTROL DE VOLUMEN</span>
                </div>

                <div class="shuffle-section">
                    <button class="shuffle-btn active" id="shuffle-btn" title="Activar/Desactivar reproducci√≥n aleatoria">
                        <i class="fas fa-random"></i>
                        <span id="shuffle-text">ALEATORIO: ON</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Next Track -->
        <section class="next-track-section">
            <div class="next-track-title">
                <i class="fas fa-forward"></i> Pr√≥xima Canci√≥n
            </div>
            <div class="next-track-info">
                <div class="next-track-name" id="next-track-name">Activa la radio para comenzar</div>
                <div class="next-track-time">
                    <i class="far fa-clock"></i>
                    <span id="next-track-time">Esperando...</span>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="radio-footer">
            <p>üìª Voz del Shaddai Radio - Emisora Online Continua</p>
            <p style="margin-top: 0.5rem; font-size: 0.8rem;">
                Reproducci√≥n autom√°tica sin interrupciones ¬∑ Transiciones suaves con crossfade profesional
            </p>
            <p style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--primary-light);">
                Modo Aleatorio Activado ¬∑ Las canciones se reproducen en orden aleatorio
            </p>
        </footer>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <div>
            <strong id="notification-title">Notificaci√≥n</strong>
            <p id="notification-message">Mensaje de notificaci√≥n</p>
        </div>
    </div>

    <script>
        // ============== SISTEMA DE RADIO ONLINE - MODO EMISORA ==============
        class RadioOnlineSystem {
            constructor() {
                // Configuraci√≥n del sistema
                this.config = {
                    // Informaci√≥n del repositorio
                    githubUser: 'cl7adv',
                    repo: 'Voz-del-Shaddai-Online',
                    musicFolder: 'musica',
                    branch: 'main',
                    
                    // URLs para GitHub - CORREGIDAS para evitar problemas de CORS
                    githubApi: 'https://api.github.com',
                    githubRaw: 'https://raw.githubusercontent.com',
                    githubPages: 'https://cl7adv.github.io/Voz-del-Shaddai-Online/musica/',
                    
                    // Configuraci√≥n de crossfade
                    crossfadeDuration: 4000,
                    fadeStartPercentage: 85,
                    
                    // Sistema de reproducci√≥n
                    defaultVolume: 0.7,
                    autoStart: false,
                    
                    // Control de tiempo
                    updateInterval: 100,
                    
                    // Tiempo de buffer
                    preloadBuffer: 5000,
                    
                    // Modo aleatorio
                    shuffleMode: true,
                    
                    // Reintentos de carga (NUEVO)
                    maxRetries: 3,
                    retryDelay: 2000
                };

                // Estado del sistema
                this.state = {
                    // Lista de reproducci√≥n
                    tracks: [],
                    currentTrackIndex: 0,
                    nextTrackIndex: 1,
                    
                    // Estado de reproducci√≥n
                    isPlaying: false,
                    isPoweredOn: false,
                    volume: this.config.defaultVolume,
                    userInteracted: false,
                    
                    // Sistema de crossfade
                    isCrossfading: false,
                    crossfadeProgress: 0,
                    currentAudio: null,
                    nextAudio: null,
                    fadeInterval: null,
                    
                    // Temporizadores
                    trackStartTime: 0,
                    nextTrackTimer: null,
                    preloadTimer: null,
                    broadcastTimer: null,
                    broadcastStartTime: Date.now(),
                    
                    // Estad√≠sticas
                    totalPlayTime: 0,
                    tracksPlayed: 0,
                    
                    // Sistema de aleatoriedad
                    shuffleHistory: [],
                    
                    // Control de errores (NUEVO)
                    retryCount: 0,
                    isUsingFallback: false,
                    currentTrackLoadAttempts: 0
                };

                // Inicializar
                this.init();
            }

            async init() {
                this.cacheElements();
                this.setupEventListeners();
                await this.loadTracksFromGitHub();
                this.createAudioElements();
                this.hideLoadingScreen();
                this.showInteractionMessage();
                this.updateShuffleButton();
            }

            cacheElements() {
                // [TODO: Esta funci√≥n se mantiene igual - todos los elementos del DOM]
                this.elements = {
                    loadingScreen: document.getElementById('loading-screen'),
                    loadingDetails: document.getElementById('loading-details'),
                    app: document.getElementById('app'),
                    interactionMessage: document.getElementById('interaction-message'),
                    enableAudioBtn: document.getElementById('enable-audio-btn'),
                    
                    // Informaci√≥n de emisora
                    broadcastStatus: document.getElementById('broadcast-status'),
                    totalTracks: document.getElementById('total-tracks'),
                    broadcastTime: document.getElementById('broadcast-time'),
                    nextIn: document.getElementById('next-in'),
                    
                    // Informaci√≥n de canci√≥n
                    trackTitle: document.getElementById('track-title'),
                    trackArtist: document.getElementById('track-artist'),
                    albumArt: document.getElementById('album-art'),
                    currentTime: document.getElementById('current-time'),
                    trackDuration: document.getElementById('track-duration'),
                    timeRemaining: document.getElementById('time-remaining'),
                    
                    // Progress
                    progressFill: document.getElementById('progress-fill'),
                    progressCurrent: document.getElementById('progress-current'),
                    progressTotal: document.getElementById('progress-total'),
                    nextChange: document.getElementById('next-change'),
                    
                    // Crossfade
                    crossfadeProgress: document.getElementById('crossfade-progress'),
                    fadePercentage: document.getElementById('fade-percentage'),
                    currentFadeStatus: document.getElementById('current-fade-status'),
                    fadeDuration: document.getElementById('fade-duration'),
                    
                    // Next track
                    nextTrackName: document.getElementById('next-track-name'),
                    nextTrackTime: document.getElementById('next-track-time'),
                    
                    // Controls
                    powerBtn: document.getElementById('power-btn'),
                    volumeSlider: document.getElementById('volume-slider'),
                    volumeValue: document.getElementById('volume-value'),
                    volumeIcon: document.getElementById('volume-icon'),
                    shuffleBtn: document.getElementById('shuffle-btn'),
                    shuffleText: document.getElementById('shuffle-text'),
                    
                    // Notification
                    notification: document.getElementById('notification'),
                    notificationTitle: document.getElementById('notification-title'),
                    notificationMessage: document.getElementById('notification-message')
                };
            }

            setupEventListeners() {
                // [TODO: Los event listeners se mantienen iguales]
                this.elements.powerBtn.addEventListener('click', () => {
                    if (this.state.userInteracted) {
                        this.togglePower();
                    } else {
                        this.showNotification('Interacci√≥n requerida', 'Primero activa la radio haciendo clic en "ACTIVAR REPRODUCCI√ìN"', 'warning');
                    }
                });
                
                this.elements.volumeSlider.addEventListener('input', (e) => {
                    this.setVolume(e.target.value / 100);
                });
                
                this.elements.shuffleBtn.addEventListener('click', () => this.toggleShuffleMode());
                
                this.elements.enableAudioBtn.addEventListener('click', () => this.enableAudioPlayback());
                
                document.addEventListener('click', () => {
                    if (!this.state.userInteracted) {
                        this.enableAudioPlayback();
                    }
                }, { once: true });
                
                document.addEventListener('keydown', () => {
                    if (!this.state.userInteracted) {
                        this.enableAudioPlayback();
                    }
                }, { once: true });
                
                setInterval(() => this.updateUI(), this.config.updateInterval);
                setInterval(() => this.updateBroadcastTime(), 1000);
            }

            // ============== MANEJO DE INTERACCI√ìN DEL USUARIO ==============
            enableAudioPlayback() {
                if (this.state.userInteracted) return;
                
                this.state.userInteracted = true;
                this.state.isPoweredOn = true;
                
                this.elements.interactionMessage.style.display = 'none';
                this.elements.powerBtn.classList.remove('off');
                this.elements.broadcastStatus.className = 'status-indicator status-online';
                this.elements.broadcastStatus.innerHTML = '<i class="fas fa-circle" style="font-size: 0.8rem;"></i><span>TRANSMITIENDO EN VIVO</span>';
                this.elements.trackTitle.textContent = 'Iniciando reproducci√≥n...';
                this.elements.nextChange.textContent = 'Cargando primera canci√≥n...';
                
                this.startSystem();
                
                this.showNotification('¬°Radio activada!', 'La reproducci√≥n comenzar√° en breve', 'success');
            }

            showInteractionMessage() {
                setTimeout(() => {
                    if (!this.state.userInteracted) {
                        this.elements.interactionMessage.style.display = 'flex';
                    }
                }, 1000);
            }

            // ============== CARGA DE CANCIONES DESDE GITHUB ==============
            async loadTracksFromGitHub() {
                try {
                    this.updateLoadingStatus('Conectando con el servidor de m√∫sica...');
                    
                    const apiUrl = `${this.config.githubApi}/repos/${this.config.githubUser}/${this.config.repo}/contents/${this.config.musicFolder}`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Error al conectar con GitHub: ${response.status}`);
                    }
                    
                    const files = await response.json();
                    
                    // Filtrar solo archivos MP3
                    const mp3Files = files.filter(file => 
                        file.type === 'file' && 
                        file.name.toLowerCase().endsWith('.mp3')
                    );
                    
                    if (mp3Files.length === 0) {
                        throw new Error('No se encontraron canciones MP3');
                    }
                    
                    // Crear lista de canciones con m√∫ltiples URLs posibles
                    this.state.tracks = mp3Files.map((file, index) => ({
                        id: index,
                        name: this.formatTrackName(file.name),
                        filename: file.name,
                        // Diferentes formas de acceder al archivo para evitar problemas de CORS
                        urls: [
                            // 1. GitHub Raw (puede tener problemas de CORS)
                            `${this.config.githubRaw}/${this.config.githubUser}/${this.config.repo}/${this.config.branch}/${this.config.musicFolder}/${encodeURIComponent(file.name)}`,
                            // 2. GitHub Pages (mejor para CORS)
                            `${this.config.githubPages}${encodeURIComponent(file.name)}`,
                            // 3. Directo al repositorio
                            `https://github.com/${this.config.githubUser}/${this.config.repo}/raw/${this.config.branch}/${this.config.musicFolder}/${encodeURIComponent(file.name)}`,
                            // 4. Con proxy CORS (como respaldo)
                            `https://corsproxy.io/?${encodeURIComponent(`https://raw.githubusercontent.com/${this.config.githubUser}/${this.config.repo}/${this.config.branch}/${this.config.musicFolder}/${encodeURIComponent(file.name)}`)}`
                        ],
                        size: file.size,
                        artist: 'Voz del Shaddai',
                        duration: null,
                        currentUrlIndex: 0 // √çndice de la URL actual que estamos probando
                    }));
                    
                    // Actualizar estad√≠sticas
                    this.elements.totalTracks.textContent = this.state.tracks.length;
                    
                    this.updateLoadingStatus(`Se encontraron ${this.state.tracks.length} canciones`);
                    this.showNotification('Lista cargada', `${this.state.tracks.length} canciones disponibles`, 'success');
                    
                } catch (error) {
                    console.error('Error cargando canciones:', error);
                    this.showNotification('Modo offline', 'Usando lista de demostraci√≥n', 'warning');
                    this.loadFallbackTracks();
                }
            }

            formatTrackName(filename) {
                let name = filename.replace('.mp3', '');
                name = name.replace(/[_\-]/g, ' ');
                name = name.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
                return name;
            }

            loadFallbackTracks() {
                // Canciones de demostraci√≥n como fallback (con URLs que sabemos que funcionan)
                this.state.tracks = [
                    {
                        id: 0,
                        name: 'Alabanza en el Esp√≠ritu',
                        filename: 'alabanza.mp3',
                        urls: [
                            'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3',
                            'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'
                        ],
                        size: 3200000,
                        artist: 'Voz del Shaddai',
                        duration: null,
                        currentUrlIndex: 0
                    },
                    {
                        id: 1,
                        name: 'C√°nticos de Adoraci√≥n',
                        filename: 'adoracion.mp3',
                        urls: [
                            'https://assets.mixkit.co/music/preview/mixkit-driving-ambition-32.mp3',
                            'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
                        ],
                        size: 2800000,
                        artist: 'Coros Celestiales',
                        duration: null,
                        currentUrlIndex: 0
                    },
                    {
                        id: 2,
                        name: 'Gloria al Alt√≠simo',
                        filename: 'gloria.mp3',
                        urls: [
                            'https://assets.mixkit.co/music/preview/mixkit-deep-urban-623.mp3',
                            'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
                        ],
                        size: 3500000,
                        artist: 'Alabanza Eterna',
                        duration: null,
                        currentUrlIndex: 0
                    }
                ];
                
                this.elements.totalTracks.textContent = this.state.tracks.length;
                this.state.isUsingFallback = true;
            }

            // ============== SISTEMA DE REPRODUCCI√ìN ALEATORIA ==============
            getRandomTrackIndex() {
                if (this.state.tracks.length <= 1) return 0;
                
                let randomIndex;
                let attempts = 0;
                const maxAttempts = 20;
                
                do {
                    randomIndex = Math.floor(Math.random() * this.state.tracks.length);
                    attempts++;
                    
                    if (attempts >= maxAttempts) {
                        break;
                    }
                } while (
                    randomIndex === this.state.currentTrackIndex || 
                    this.state.shuffleHistory.includes(randomIndex)
                );
                
                this.state.shuffleHistory.push(randomIndex);
                if (this.state.shuffleHistory.length > 10) {
                    this.state.shuffleHistory.shift();
                }
                
                return randomIndex;
            }

            getNextTrackIndex() {
                if (this.config.shuffleMode) {
                    return this.getRandomTrackIndex();
                } else {
                    return (this.state.currentTrackIndex + 1) % this.state.tracks.length;
                }
            }

            toggleShuffleMode() {
                if (!this.state.userInteracted) {
                    this.showNotification('Interacci√≥n requerida', 'Primero activa la radio', 'warning');
                    return;
                }
                
                this.config.shuffleMode = !this.config.shuffleMode;
                this.updateShuffleButton();
                
                if (this.config.shuffleMode) {
                    this.showNotification('Modo aleatorio activado', 'Las canciones se reproducir√°n en orden aleatorio', 'info');
                } else {
                    this.showNotification('Modo secuencial activado', 'Las canciones se reproducir√°n en orden', 'info');
                }
            }

            updateShuffleButton() {
                if (this.config.shuffleMode) {
                    this.elements.shuffleBtn.classList.add('active');
                    this.elements.shuffleText.textContent = 'ALEATORIO: ON';
                } else {
                    this.elements.shuffleBtn.classList.remove('active');
                    this.elements.shuffleText.textContent = 'ALEATORIO: OFF';
                }
            }

            // ============== SISTEMA DE AUDIO MEJORADO CON REINTENTOS ==============
            createAudioElements() {
                this.state.currentAudio = new Audio();
                this.state.currentAudio.crossOrigin = "anonymous";
                this.state.currentAudio.preload = "none"; // Cambiado a "none" para mejor control
                
                this.state.nextAudio = new Audio();
                this.state.nextAudio.crossOrigin = "anonymous";
                this.state.nextAudio.preload = "none";
                
                // Configurar eventos
                this.setupAudioEvents(this.state.currentAudio, 'current');
                this.setupAudioEvents(this.state.nextAudio, 'next');
            }

            setupAudioEvents(audio, type) {
                // Limpiar eventos anteriores primero
                audio.onerror = null;
                audio.onloadeddata = null;
                audio.oncanplay = null;
                audio.onended = null;
                
                audio.addEventListener('loadeddata', () => this.onTrackLoaded(type));
                audio.addEventListener('error', (e) => this.onAudioError(e, type));
                audio.addEventListener('ended', () => this.onTrackEnded(type));
                audio.addEventListener('canplay', () => this.onCanPlay(type));
            }

            // ============== SISTEMA PRINCIPAL DE REPRODUCCI√ìN CON REINTENTOS ==============
            async startSystem() {
                if (this.state.tracks.length === 0) {
                    this.showNotification('Error', 'No hay canciones disponibles', 'error');
                    return;
                }
                
                // Seleccionar canciones iniciales
                if (this.config.shuffleMode) {
                    this.state.currentTrackIndex = this.getRandomTrackIndex();
                    
                    do {
                        this.state.nextTrackIndex = this.getRandomTrackIndex();
                    } while (this.state.nextTrackIndex === this.state.currentTrackIndex);
                }
                
                // Cargar primera canci√≥n con reintentos
                await this.loadTrackWithRetry(this.state.currentTrackIndex, 'current');
                
                // Cargar siguiente canci√≥n
                await this.loadTrackWithRetry(this.state.nextTrackIndex, 'next');
                
                // Iniciar reproducci√≥n
                setTimeout(() => {
                    this.playCurrentTrack();
                }, 500);
            }

            // NUEVO M√âTODO: Cargar pista con reintentos
            async loadTrackWithRetry(trackIndex, type, retryCount = 0) {
                if (trackIndex < 0 || trackIndex >= this.state.tracks.length) return;
                
                const track = this.state.tracks[trackIndex];
                const audio = type === 'current' ? this.state.currentAudio : this.state.nextAudio;
                
                // Resetear el audio primero
                audio.src = '';
                audio.load();
                
                // Usar la siguiente URL disponible
                const urlIndex = track.currentUrlIndex % track.urls.length;
                const url = track.urls[urlIndex];
                
                try {
                    console.log(`Intentando cargar ${type} track con URL ${urlIndex}: ${url}`);
                    
                    audio.src = url;
                    audio.load();
                    
                    // Esperar a que el audio est√© listo
                    await new Promise((resolve, reject) => {
                        const onSuccess = () => {
                            audio.removeEventListener('canplay', onSuccess);
                            audio.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            audio.removeEventListener('canplay', onSuccess);
                            audio.removeEventListener('error', onError);
                            reject(e);
                        };
                        
                        audio.addEventListener('canplay', onSuccess, { once: true });
                        audio.addEventListener('error', onError, { once: true });
                        
                        // Timeout despu√©s de 10 segundos
                        setTimeout(() => {
                            audio.removeEventListener('canplay', onSuccess);
                            audio.removeEventListener('error', onError);
                            reject(new Error('Timeout loading audio'));
                        }, 10000);
                    });
                    
                    // √âxito: actualizar informaci√≥n
                    if (type === 'current') {
                        this.updateTrackInfo(track);
                        this.elements.trackTitle.textContent = track.name;
                        this.elements.trackArtist.textContent = track.artist;
                    } else if (type === 'next') {
                        this.elements.nextTrackName.textContent = track.name;
                    }
                    
                    console.log(`‚úì ${type} track cargado exitosamente`);
                    this.state.retryCount = 0; // Resetear contador de reintentos
                    
                } catch (error) {
                    console.error(`‚úó Error cargando ${type} track (intento ${retryCount + 1}):`, error);
                    
                    if (retryCount < this.config.maxRetries - 1) {
                        // Intentar con la siguiente URL
                        track.currentUrlIndex = (track.currentUrlIndex + 1) % track.urls.length;
                        
                        this.showNotification('Reintentando...', `Problema con la canci√≥n "${track.name}"`, 'warning');
                        
                        // Esperar y reintentar
                        await new Promise(resolve => setTimeout(resolve, this.config.retryDelay));
                        return this.loadTrackWithRetry(trackIndex, type, retryCount + 1);
                    } else {
                        // Todos los reintentos fallaron
                        console.error(`Todos los reintentos fallaron para ${track.name}`);
                        
                        if (type === 'current') {
                            this.showNotification('Error de carga', `No se pudo cargar "${track.name}". Saltando a siguiente canci√≥n...`, 'error');
                            
                            // Saltar a la siguiente canci√≥n
                            setTimeout(() => {
                                this.skipToNextTrack();
                            }, 2000);
                        }
                    }
                }
            }

            skipToNextTrack() {
                if (this.config.shuffleMode) {
                    this.state.currentTrackIndex = this.getRandomTrackIndex();
                    this.state.nextTrackIndex = this.getRandomTrackIndex();
                    
                    while (this.state.nextTrackIndex === this.state.currentTrackIndex) {
                        this.state.nextTrackIndex = this.getRandomTrackIndex();
                    }
                } else {
                    this.state.currentTrackIndex = (this.state.currentTrackIndex + 1) % this.state.tracks.length;
                    this.state.nextTrackIndex = (this.state.currentTrackIndex + 1) % this.state.tracks.length;
                }
                
                // Recargar tracks
                this.loadTrackWithRetry(this.state.currentTrackIndex, 'current');
                this.loadTrackWithRetry(this.state.nextTrackIndex, 'next');
                
                // Continuar reproducci√≥n si estaba activa
                if (this.state.isPlaying) {
                    setTimeout(() => {
                        this.playCurrentTrack();
                    }, 1000);
                }
            }

            updateTrackInfo(track) {
                this.updateAlbumArtColors();
                this.state.tracksPlayed++;
            }

            // ============== REPRODUCCI√ìN DE AUDIO MEJORADA ==============
            async playCurrentTrack() {
                if (!this.state.isPoweredOn || this.state.tracks.length === 0 || !this.state.userInteracted) return;
                
                if (!this.state.currentAudio.src) {
                    console.error('No hay fuente de audio cargada');
                    this.skipToNextTrack();
                    return;
                }
                
                try {
                    // Verificar si el audio est√° listo
                    if (this.state.currentAudio.readyState < 2) { // 2 = HAVE_CURRENT_DATA
                        console.log('Audio no est√° listo, esperando...');
                        await new Promise(resolve => {
                            const checkReady = () => {
                                if (this.state.currentAudio.readyState >= 2) {
                                    resolve();
                                } else {
                                    setTimeout(checkReady, 100);
                                }
                            };
                            checkReady();
                        });
                    }
                    
                    // Configurar volumen antes de reproducir
                    this.state.currentAudio.volume = this.state.volume;
                    
                    // Intentar reproducir
                    const playPromise = this.state.currentAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                    }
                    
                    // √âxito
                    this.state.isPlaying = true;
                    this.state.trackStartTime = Date.now();
                    this.state.broadcastStartTime = Date.now();
                    
                    // Actualizar UI
                    this.elements.albumArt.classList.add('playing');
                    this.elements.currentFadeStatus.textContent = 'Sistema de crossfade activo';
                    
                    // Programar crossfade
                    this.scheduleCrossfade();
                    
                    this.showNotification('¬°Emisora en vivo!', 'Disfruta de la m√∫sica continua', 'success');
                    
                } catch (error) {
                    console.error('Error al reproducir:', error);
                    
                    if (error.name === 'AbortError') {
                        console.log('Play() interrumpido, reintentando...');
                        setTimeout(() => {
                            this.playCurrentTrack();
                        }, 500);
                    } else if (error.name === 'NotAllowedError') {
                        this.showNotification('Permiso requerido', 'El navegador bloque√≥ la reproducci√≥n. Intenta activar la radio de nuevo.', 'warning');
                        this.state.isPlaying = false;
                    } else {
                        // Otro error, saltar canci√≥n
                        this.showNotification('Error de reproducci√≥n', 'Saltando a siguiente canci√≥n...', 'error');
                        this.state.isPlaying = false;
                        
                        setTimeout(() => {
                            this.skipToNextTrack();
                        }, 2000);
                    }
                }
            }

            // ============== MANEJO DE ERRORES MEJORADO ==============
            onAudioError(error, type) {
                console.error(`Error en audio ${type}:`, error);
                console.error('Detalles del error:', {
                    errorCode: this.state.currentAudio.error ? this.state.currentAudio.error.code : 'N/A',
                    errorMessage: this.state.currentAudio.error ? this.state.currentAudio.error.message : 'N/A',
                    src: this.state.currentAudio.src,
                    networkState: this.state.currentAudio.networkState,
                    readyState: this.state.currentAudio.readyState
                });
                
                if (type === 'current') {
                    this.state.currentTrackLoadAttempts++;
                    
                    if (this.state.currentTrackLoadAttempts < 3) {
                        // Reintentar con otra URL
                        const track = this.state.tracks[this.state.currentTrackIndex];
                        track.currentUrlIndex = (track.currentUrlIndex + 1) % track.urls.length;
                        
                        console.log(`Reintentando canci√≥n actual con URL index: ${track.currentUrlIndex}`);
                        
                        setTimeout(() => {
                            this.loadTrackWithRetry(this.state.currentTrackIndex, 'current');
                            if (this.state.isPlaying) {
                                this.playCurrentTrack();
                            }
                        }, 1000);
                    } else {
                        // Demasiados intentos, saltar canci√≥n
                        this.showNotification('Error de carga', 'Saltando a siguiente canci√≥n...', 'warning');
                        this.state.currentTrackLoadAttempts = 0;
                        
                        setTimeout(() => {
                            this.skipToNextTrack();
                        }, 1000);
                    }
                }
            }

            // ============== [EL RESTO DE LOS M√âTODOS SE MANTIENEN SIMILARES] ==============
            // scheduleCrossfade(), startCrossfade(), completeCrossfade(), togglePower(), 
            // setVolume(), updateUI(), updateBroadcastTime(), etc.
            // (Por brevedad, no los repito todos, pero deben estar presentes en el c√≥digo completo)

            // M√âTODOS RESTANTES (simplificados por espacio):
            scheduleCrossfade() {
                this.clearAllTimers();
                
                const currentAudio = this.state.currentAudio;
                const duration = currentAudio.duration || 180;
                const fadeStartTime = (duration * (this.config.fadeStartPercentage / 100)) * 1000;
                const timeUntilFade = fadeStartTime - this.config.crossfadeDuration;
                
                this.state.nextTrackTimer = setTimeout(() => {
                    this.startCrossfade();
                }, Math.max(0, timeUntilFade));
                
                this.updateNextChangeTime(timeUntilFade);
            }

            clearAllTimers() {
                if (this.state.nextTrackTimer) clearTimeout(this.state.nextTrackTimer);
                if (this.state.preloadTimer) clearTimeout(this.state.preloadTimer);
                if (this.state.fadeInterval) clearInterval(this.state.fadeInterval);
            }

            async startCrossfade() {
                if (this.state.isCrossfading || !this.state.isPoweredOn || !this.state.userInteracted) return;
                
                this.state.isCrossfading = true;
                this.elements.currentFadeStatus.textContent = 'Transici√≥n en progreso...';
                
                const startTime = Date.now();
                const duration = this.config.crossfadeDuration;
                
                this.clearAllTimers();
                
                try {
                    const playPromise = this.state.nextAudio.play();
                    if (playPromise !== undefined) await playPromise;
                } catch (error) {
                    console.error('Error iniciando siguiente canci√≥n:', error);
                }
                
                this.state.fadeInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    this.state.crossfadeProgress = progress;
                    this.elements.crossfadeProgress.style.width = (progress * 100) + '%';
                    this.elements.fadePercentage.textContent = Math.round(progress * 100) + '%';
                    
                    const fadeOut = progress;
                    const fadeIn = progress;
                    
                    if (this.state.currentAudio) {
                        this.state.currentAudio.volume = Math.max(0, this.state.volume * (1 - fadeOut));
                    }
                    
                    if (this.state.nextAudio) {
                        this.state.nextAudio.volume = Math.min(this.state.volume, this.state.volume * fadeIn);
                    }
                    
                    if (progress >= 1) {
                        clearInterval(this.state.fadeInterval);
                        this.completeCrossfade();
                    }
                }, 16);
            }

            completeCrossfade() {
                if (this.state.currentAudio) {
                    this.state.currentAudio.pause();
                    this.state.currentAudio.currentTime = 0;
                    this.state.currentAudio.volume = 0;
                }
                
                const oldCurrent = this.state.currentAudio;
                this.state.currentAudio = this.state.nextAudio;
                this.state.currentAudio.volume = this.state.volume;
                
                this.state.currentTrackIndex = this.state.nextTrackIndex;
                
                if (this.config.shuffleMode) {
                    do {
                        this.state.nextTrackIndex = this.getRandomTrackIndex();
                    } while (this.state.nextTrackIndex === this.state.currentTrackIndex);
                } else {
                    this.state.nextTrackIndex = (this.state.nextTrackIndex + 1) % this.state.tracks.length;
                }
                
                this.state.nextAudio = new Audio();
                this.state.nextAudio.crossOrigin = "anonymous";
                this.state.nextAudio.preload = "none";
                this.state.nextAudio.volume = 0;
                this.setupAudioEvents(this.state.nextAudio, 'next');
                
                // Cargar nueva siguiente canci√≥n
                const nextTrack = this.state.tracks[this.state.nextTrackIndex];
                this.state.nextAudio.src = nextTrack.urls[0];
                
                const currentTrack = this.state.tracks[this.state.currentTrackIndex];
                this.updateTrackInfo(currentTrack);
                this.elements.nextTrackName.textContent = nextTrack.name;
                this.updateAlbumArtColors();
                
                setTimeout(() => {
                    if (oldCurrent) oldCurrent.src = '';
                }, 1000);
                
                this.state.isCrossfading = false;
                this.state.crossfadeProgress = 0;
                this.elements.crossfadeProgress.style.width = '0%';
                this.elements.fadePercentage.textContent = '0%';
                this.elements.currentFadeStatus.textContent = 'Sistema de crossfade activo';
                
                this.scheduleCrossfade();
            }

            onTrackLoaded(type) {
                if (type === 'current') {
                    const track = this.state.tracks[this.state.currentTrackIndex];
                    if (track) {
                        track.duration = this.state.currentAudio.duration;
                    }
                }
            }

            onTrackEnded(type) {
                if (type === 'current' && !this.state.isCrossfading) {
                    this.skipToNextTrack();
                }
            }

            onCanPlay(type) {
                if (type === 'next') {
                    console.log('Siguiente canci√≥n lista para reproducir');
                }
            }

            togglePower() {
                if (!this.state.userInteracted) {
                    this.showNotification('Interacci√≥n requerida', 'Primero activa la radio', 'warning');
                    return;
                }
                
                this.state.isPoweredOn = !this.state.isPoweredOn;
                
                if (this.state.isPoweredOn) {
                    this.elements.powerBtn.classList.remove('off');
                    
                    if (this.config.shuffleMode) {
                        this.state.currentTrackIndex = this.getRandomTrackIndex();
                        
                        do {
                            this.state.nextTrackIndex = this.getRandomTrackIndex();
                        } while (this.state.nextTrackIndex === this.state.currentTrackIndex);
                        
                        this.loadTrackWithRetry(this.state.currentTrackIndex, 'current').then(() => {
                            this.loadTrackWithRetry(this.state.nextTrackIndex, 'next').then(() => {
                                this.playCurrentTrack();
                            });
                        });
                    } else {
                        this.playCurrentTrack();
                    }
                    
                    this.showNotification('Radio encendida', 'Disfruta de la m√∫sica', 'success');
                } else {
                    this.elements.powerBtn.classList.add('off');
                    this.state.isPlaying = false;
                    
                    if (this.state.currentAudio) {
                        const fadeInterval = setInterval(() => {
                            if (this.state.currentAudio.volume > 0) {
                                this.state.currentAudio.volume = Math.max(0, this.state.currentAudio.volume - 0.1);
                            } else {
                                clearInterval(fadeInterval);
                                this.state.currentAudio.pause();
                            }
                        }, 50);
                    }
                    
                    this.elements.albumArt.classList.remove('playing');
                    this.clearAllTimers();
                    
                    this.elements.broadcastStatus.className = 'status-indicator status-offline';
                    this.elements.broadcastStatus.innerHTML = '<i class="fas fa-circle" style="font-size: 0.8rem;"></i><span>EMISORA APAGADA</span>';
                    
                    this.showNotification('Radio apagada', 'Reproducci√≥n detenida', 'info');
                }
            }

            setVolume(value) {
                this.state.volume = Math.max(0, Math.min(1, value));
                
                if (this.state.currentAudio) {
                    this.state.currentAudio.volume = this.state.volume;
                }
                
                if (this.state.nextAudio && this.state.isCrossfading) {
                    this.state.nextAudio.volume = this.state.volume;
                }
                
                const percentage = Math.round(this.state.volume * 100);
                this.elements.volumeValue.textContent = percentage + '%';
                this.elements.volumeSlider.value = percentage;
                
                let icon = 'fa-volume-up';
                if (percentage === 0) icon = 'fa-volume-mute';
                else if (percentage < 30) icon = 'fa-volume-down';
                else if (percentage < 70) icon = 'fa-volume-low';
                
                this.elements.volumeIcon.className = 'fas ' + icon;
            }

            updateUI() {
                if (!this.state.currentAudio || !this.state.isPlaying) return;
                
                const currentTime = this.state.currentAudio.currentTime;
                const duration = this.state.currentAudio.duration || 1;
                const progress = (currentTime / duration) * 100;
                
                this.elements.progressFill.style.width = progress + '%';
                this.elements.currentTime.textContent = this.formatTime(currentTime);
                this.elements.progressCurrent.textContent = this.formatTime(currentTime);
                
                if (duration && !isNaN(duration)) {
                    this.elements.trackDuration.textContent = this.formatTime(duration);
                    this.elements.progressTotal.textContent = this.formatTime(duration);
                    this.elements.timeRemaining.textContent = '-' + this.formatTime(duration - currentTime);
                }
            }

            updateBroadcastTime() {
                if (!this.state.isPlaying) return;
                
                const elapsed = Date.now() - this.state.broadcastStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr = hours.toString().padStart(2, '0') + ':' + 
                             minutes.toString().padStart(2, '0') + ':' + 
                             seconds.toString().padStart(2, '0');
                } else {
                    timeStr = minutes.toString().padStart(2, '0') + ':' + 
                             seconds.toString().padStart(2, '0');
                }
                
                this.elements.broadcastTime.textContent = timeStr;
            }

            updateNextChangeTime(timeUntilFade) {
                if (timeUntilFade <= 0) return;
                
                const minutes = Math.floor(timeUntilFade / 60000);
                const seconds = Math.floor((timeUntilFade % 60000) / 1000);
                
                this.elements.nextChange.textContent = `Pr√≥ximo cambio autom√°tico en: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                this.elements.nextTrackTime.textContent = `En ${minutes}:${seconds.toString().padStart(2, '0')}`;
                this.elements.nextIn.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            updateAlbumArtColors() {
                const hue = (this.state.currentTrackIndex * 137) % 360;
                const color1 = `hsl(${hue}, 80%, 45%)`;
                const color2 = `hsl(${(hue + 60) % 360}, 80%, 45%)`;
                
                this.elements.albumArt.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '00:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
            }

            showNotification(title, message, type = 'info') {
                this.elements.notificationTitle.textContent = title;
                this.elements.notificationMessage.textContent = message;
                
                let borderColor = '#1a73e8';
                if (type === 'success') borderColor = '#34a853';
                if (type === 'error') borderColor = '#ea4335';
                if (type === 'warning') borderColor = '#fbbc05';
                
                this.elements.notification.style.borderLeftColor = borderColor;
                this.elements.notification.classList.add('show');
                
                setTimeout(() => {
                    this.elements.notification.classList.remove('show');
                }, 3000);
            }

            updateLoadingStatus(message) {
                if (this.elements.loadingDetails) {
                    this.elements.loadingDetails.textContent = message;
                }
            }

            hideLoadingScreen() {
                setTimeout(() => {
                    this.elements.loadingScreen.style.opacity = '0';
                    
                    setTimeout(() => {
                        this.elements.loadingScreen.style.display = 'none';
                        this.elements.app.style.display = 'block';
                        
                        setTimeout(() => {
                            this.elements.app.classList.add('app-loaded');
                        }, 50);
                    }, 500);
                }, 1000);
            }
        }

        // ============== INICIAR SISTEMA ==============
        document.addEventListener('DOMContentLoaded', () => {
            window.radioSystem = new RadioOnlineSystem();
        });
    </script>
</body>
</html>
